name: aws_cloudtrail_iam
author: Antimatter
description: "Processing for AWS CloudTrail IAM logs"
title: "AWS - CloudTrail IAM"
iconURL: "https://raw.githubusercontent.com/antimatterhq/dasl-content-packs/refs/heads/main/presets/aws/cloudtrail_iam/icon.png"
autoloader:
  format: json
bronze:
  loadAsSingleVariant: true

silver:
  preTransform:
    - name: aws_cloudtrail
      fields:
        - name: raw
          expr: explode_outer(CAST(`data`:Records AS array<variant>))
      postFilter: raw:eventSource::string = 'iam.amazonaws.com'

  transform:
    - name: aws_cloudtrail_account_change
      filter: | 
        raw:eventName::string in (
          'ChangePassword', 'CreateLoginProfile', 'DeleteLoginProfile', 'UpdateLoginProfile', 'CreateUser', 'DeleteUser', 'UpdateUser', 'CreateVirtualMFADevice', 'DeactivateMFADevice', 'DeleteVirtualMFADevice', 'EnableMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'ResetServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'AttachRolePolicy', 'DetachRolePolicy', 'PutRolePolicy', 'DeleteRolePolicy', 'PutRolePermissionsBoundary', 'DeleteRolePermissionsBoundary', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
                CAST(raw:userIdentity AS STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>)
          - name: tlsDetails
            expr: |
                CAST(raw:tlsDetails AS STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>)
          - name: addendum
            expr: |
                CAST(raw:addendum AS STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>)
          - name: resources
            expr: |
                CAST(raw:resources AS ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>)
      fields:
        - name: time
          expr: raw:eventTime::timestamp
        - name: eventName
          expr: raw:eventName::string
        - name: eventCategory
          expr: raw:eventCategory::string
        - name: eventType
          expr: raw:eventType::string
        - name: eventSource
          expr: raw:eventSource::string

        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          expr: raw:awsRegion::string
        - name: sourceIPAddress
          expr: raw:sourceIPAddress::string
        - name: userAgent
          expr: raw:userAgent::string
        - name: errorCode
          expr: raw:errorCode::string
        - name: errorMessage
          expr: raw:errorMessage::string
        - name: requestParameters
          expr: raw:requestParameters::string
        - name: responseElements
          expr: raw:responseElements::string
        - name: additionalEventData
          expr: raw:additionalEventData::string
        - name: requestID
          expr: raw:requestID::string
        - name: eventID
          expr: raw:eventID::string
        - name: apiVersion
          expr: raw:apiVersion::string
        - name: managementEvent
          expr: raw:managementEvent::string
        - name: readOnly
          expr: raw:readOnly::BOOLEAN

        - name: eventVersion
          expr: raw:eventVersion::string
        - name: recipientAccountId
          expr: raw:recipientAccountId::string
        - name: serviceEventDetails
          expr: raw:serviceEventDetails::string
        - name: sharedEventID
          expr: raw:sharedEventID::string
        - name: vpcEndpointId
          expr: raw:vpcEndpointId::string
        - name: vpcEndpointAccountId
          expr: raw:vpcEndpointAccountId::string
        - name: sessionCredentialFromConsole
          expr: raw:sessionCredentialFromConsole::string
        - name: edgeDeviceDetails
          expr: raw:edgeDeviceDetails::string
        - name: resources
          from: resources
        - name: target.accessKeyId
          expr: raw:requestParameters.accessKeyId::string
        
        - name: target.clientId
          expr: raw:requestParameters.clientId::string
        - name: target.entityPath
          expr: raw:requestParameters.entityPath::string
        - name: target.groupName
          expr: raw:requestParameters.groupName::string
        - name: target.instanceProfileName
          expr: raw:requestParameters.instanceProfileName::string
        - name: target.jobId
          expr: raw:requestParameters.jobId::string
        - name: target.name
          expr: raw:requestParameters.name::string
        - name: target.policyArn
          expr: raw:requestParameters.policyArn::string
        - name: target.policyName
          expr: raw:requestParameters.policyName::string
        - name: target.roleName
          expr: raw:requestParameters.roleName::string
        - name: target.openIDConnectProviderArn
          expr: raw:requestParameters.openIDConnectProviderArn::string
        - name: target.organizationId
          expr: raw:requestParameters.organizationId::string
        - name: target.policyDocument
          expr: raw:requestParameters.policyDocument::string
        - name: target.policySourceArn
          expr: raw:requestParameters.policySourceArn::string
        - name: target.samlProviderArn
          expr: raw:requestParameters.samlProviderArn::string
        - name: target.serialNumber
          expr: raw:requestParameters.serialNumber::string
        - name: target.serverCertificateName
          expr: raw:requestParameters.serverCertificateName::string
        - name: target.sshPublicKeyId
          expr: raw:requestParameters.sshPublicKeyId::string
        - name: target.userName
          expr: raw:requestParameters.userName::string
        - name: target.versionId
          expr: raw:requestParameters.versionId::string

