name: aws_cloudtrail_iam
author: Antimatter
description: "Processing for AWS CloudTrail IAM logs"
title: "AWS - CloudTrail IAM"
iconURL: "https://raw.githubusercontent.com/antimatterhq/dasl-content-packs/refs/heads/main/presets/aws/cloudtrail_iam/icon.png"
autoloader:
  format: json

bronze:
  loadAsSingleVariant: true
  preTransform: [
    [
      "explode_outer(CAST(`data`:Records AS array<variant>)) AS data",
    ],
    [
      "data",
      "data:eventTime::TIMESTAMP AS time",
      "CAST('aws' AS STRING) AS source", 
      "CAST('cloudtrail_iam' AS STRING) AS sourcetype"
    ]
  ]


silver:
  preTransform:
    - name: aws_cloudtrail
      fields:
        - name: time
          from: time
        - name: raw
          expr: |
            STRUCT(
              data:eventTime::STRING AS eventTime,
              data:eventVersion::STRING AS eventVersion,
              data:userIdentity::STRING AS userIdentity,
              data:eventSource::STRING AS eventSource,
              data:eventName::STRING AS eventName,
              data:awsRegion::STRING AS awsRegion,
              data:sourceIPAddress::STRING AS sourceIPAddress,
              data:userAgent::STRING AS userAgent,
              data:errorCode::STRING AS errorCode,
              data:errorMessage::STRING AS errorMessage,
              data:requestParameters::STRING AS requestParameters,
              data:responseElements::STRING AS responseElements,
              data:additionalEventData::STRING AS additionalEventData,
              data:requestID::STRING AS requestID,
              data:eventID::STRING AS eventID,
              data:eventType::STRING AS eventType,
              data:apiVersion::STRING AS apiVersion,
              data:managementEvent::BOOLEAN AS managementEvent,
              data:readOnly::STRING AS readOnly,
              data:resources::STRING AS resources,
              data:recipientAccountId::STRING AS recipientAccountId,
              data:serviceEventDetails::STRING AS serviceEventDetails,
              data:sharedEventID::STRING AS sharedEventID,
              data:vpcEndpointId::STRING AS vpcEndpointId,
              data:vpcEndpointAccountId::STRING AS vpcEndpointAccountId,
              data:eventCategory::STRING AS eventCategory,
              data:addendum::STRING AS addendum,
              data:sessionCredentialFromConsole::STRING AS sessionCredentialFromConsole,
              data:edgeDeviceDetails::STRING AS edgeDeviceDetails,
              data:tlsDetails::STRING AS tlsDetails
            )
        
      postFilter: raw.eventSource = 'iam.amazonaws.com'

  transform:
    - name: aws_cloudtrail_account_change
      filter: | 
        raw.eventName in (
          'ChangePassword', 'CreateLoginProfile', 'DeleteLoginProfile', 'UpdateLoginProfile', 'CreateUser', 'DeleteUser', 'UpdateUser', 'CreateVirtualMFADevice', 'DeactivateMFADevice', 'DeleteVirtualMFADevice', 'EnableMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'ResetServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'AttachRolePolicy', 'DetachRolePolicy', 'PutRolePolicy', 'DeleteRolePolicy', 'PutRolePermissionsBoundary', 'DeleteRolePermissionsBoundary', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
              from_json(raw.userIdentity, 'STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>')
          - name: tlsDetails
            expr: "from_json(raw.tlsDetails, 'STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>')"
          - name: addendum
            expr: "from_json(raw.addendum, 'STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>')"
          - name: resources
            expr: "from_json(raw.resources, 'ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>')"
      fields:
        - name: time
          from: time
        - name: eventTime
          from: raw.eventTime
        - name: eventName
          from: raw.eventName
        - name: eventCategory
          from: raw.eventCategory
        - name: eventType
          from: raw.eventType
        - name: eventSource
          from: raw.eventSource
        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          from: raw.awsRegion
        - name: sourceIPAddress
          from: raw.sourceIPAddress
        - name: userAgent
          from: raw.userAgent
        - name: errorCode
          from: raw.errorCode
        - name: errorMessage
          from: raw.errorMessage
        - name: requestParameters
          from: raw.requestParameters
        - name: responseElements
          from: raw.responseElements
        - name: additionalEventData
          from: raw.additionalEventData
        - name: requestID
          from: raw.requestID
        - name: eventID
          from: raw.eventID
        - name: apiVersion
          from: raw.apiVersion
        - name: managementEvent
          from: raw.managementEvent
        - name: readOnly
          expr: CAST(raw.readOnly AS BOOLEAN) 
        - name: eventVersion
          from: raw.eventVersion
        - name: recipientAccountId
          from: raw.recipientAccountId
        - name: serviceEventDetails
          from: raw.serviceEventDetails
        - name: sharedEventID
          from: raw.sharedEventID
        - name: vpcEndpointId
          from: raw.vpcEndpointId
        - name: vpcEndpointAccountId
          from: raw.vpcEndpointAccountId
        - name: sessionCredentialFromConsole
          from: raw.sessionCredentialFromConsole
        - name: edgeDeviceDetails
          from: raw.edgeDeviceDetails
        - name: resources
          from: resources
        - name: target.accessKeyId
          expr: get_json_object(raw.requestParameters, '$.accessKeyId')
        - name: target.clientId
          expr: get_json_object(raw.requestParameters, '$.clientId')
        - name: target.entityPath
          expr: get_json_object(raw.requestParameters, '$.entityPath')
        - name: target.groupName
          expr: get_json_object(raw.requestParameters, '$.groupName')
        - name: target.instanceProfileName
          expr: get_json_object(raw.requestParameters, '$.instanceProfileName')
        - name: target.jobId
          expr: get_json_object(raw.requestParameters, '$.jobId')
        - name: target.name
          expr: get_json_object(raw.requestParameters, '$.name')
        - name: target.policyArn
          expr: get_json_object(raw.requestParameters, '$.policyArn')
        - name: target.policyName
          expr: get_json_object(raw.requestParameters, '$.policyName')
        - name: target.roleName
          expr: get_json_object(raw.requestParameters, '$.roleName')
        - name: target.openIDConnectProviderArn
          expr: get_json_object(raw.requestParameters, '$.openIDConnectProviderArn')
        - name: target.organizationId
          expr: get_json_object(raw.requestParameters, '$.organizationId')
        - name: target.policyDocument
          expr: get_json_object(raw.requestParameters, '$.policyDocument')
        - name: target.policySourceArn
          expr: get_json_object(raw.requestParameters, '$.policySourceArn')
        - name: target.samlProviderArn
          expr: get_json_object(raw.requestParameters, '$.samlProviderArn')
        - name: target.serialNumber
          expr: get_json_object(raw.requestParameters, '$.serialNumber')
        - name: target.serverCertificateName
          expr: get_json_object(raw.requestParameters, '$.serverCertificateName')
        - name: target.sshPublicKeyId
          expr: get_json_object(raw.requestParameters, '$.sshPublicKeyId')
        - name: target.userName
          expr: get_json_object(raw.requestParameters, '$.userName')
        - name: target.versionId
          expr: get_json_object(raw.requestParameters, '$.versionId')

          
    - name: aws_cloudtrail_entity_management
      filter: | 
        raw.eventName in (
          'GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole', 'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate', 'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices', 'TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate', 'CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider', 'CreateServiceLinkedRole', 'UploadServerCertificate', 'DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole', 'DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions', 'EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
              from_json(raw.userIdentity, 'STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>')
          - name: tlsDetails
            expr: "from_json(raw.tlsDetails, 'STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>')"
          - name: addendum
            expr: "from_json(raw.addendum, 'STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>')"
          - name: resources
            expr: "from_json(raw.resources, 'ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>')"
      fields:
        - name: time
          from: time
        - name: eventTime
          from: raw.eventTime
        - name: eventName
          from: raw.eventName
        - name: eventCategory
          from: raw.eventCategory
        - name: eventType
          from: raw.eventType
        - name: eventSource
          from: raw.eventSource
        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          from: raw.awsRegion
        - name: sourceIPAddress
          from: raw.sourceIPAddress
        - name: userAgent
          from: raw.userAgent
        - name: errorCode
          from: raw.errorCode
        - name: errorMessage
          from: raw.errorMessage
        - name: requestParameters
          from: raw.requestParameters
        - name: responseElements
          from: raw.responseElements
        - name: additionalEventData
          from: raw.additionalEventData
        - name: requestID
          from: raw.requestID
        - name: eventID
          from: raw.eventID
        - name: apiVersion
          from: raw.apiVersion
        - name: managementEvent
          from: raw.managementEvent
        - name: readOnly
          expr: CAST(raw.readOnly AS BOOLEAN) 
        - name: eventVersion
          from: raw.eventVersion
        - name: recipientAccountId
          from: raw.recipientAccountId
        - name: serviceEventDetails
          from: raw.serviceEventDetails
        - name: sharedEventID
          from: raw.sharedEventID
        - name: vpcEndpointId
          from: raw.vpcEndpointId
        - name: vpcEndpointAccountId
          from: raw.vpcEndpointAccountId
        - name: sessionCredentialFromConsole
          from: raw.sessionCredentialFromConsole
        - name: edgeDeviceDetails
          from: raw.edgeDeviceDetails
        - name: resources
          from: resources
        - name: target.accessKeyId
          expr: get_json_object(raw.requestParameters, '$.accessKeyId')
        - name: target.clientId
          expr: get_json_object(raw.requestParameters, '$.clientId')
        - name: target.entityPath
          expr: get_json_object(raw.requestParameters, '$.entityPath')
        - name: target.groupName
          expr: get_json_object(raw.requestParameters, '$.groupName')
        - name: target.instanceProfileName
          expr: get_json_object(raw.requestParameters, '$.instanceProfileName')
        - name: target.jobId
          expr: get_json_object(raw.requestParameters, '$.jobId')
        - name: target.name
          expr: get_json_object(raw.requestParameters, '$.name')
        - name: target.policyArn
          expr: get_json_object(raw.requestParameters, '$.policyArn')
        - name: target.policyName
          expr: get_json_object(raw.requestParameters, '$.policyName')
        - name: target.roleName
          expr: get_json_object(raw.requestParameters, '$.roleName')
        - name: target.openIDConnectProviderArn
          expr: get_json_object(raw.requestParameters, '$.openIDConnectProviderArn')
        - name: target.organizationId
          expr: get_json_object(raw.requestParameters, '$.organizationId')
        - name: target.policyDocument
          expr: get_json_object(raw.requestParameters, '$.policyDocument')
        - name: target.policySourceArn
          expr: get_json_object(raw.requestParameters, '$.policySourceArn')
        - name: target.samlProviderArn
          expr: get_json_object(raw.requestParameters, '$.samlProviderArn')
        - name: target.serialNumber
          expr: get_json_object(raw.requestParameters, '$.serialNumber')
        - name: target.serverCertificateName
          expr: get_json_object(raw.requestParameters, '$.serverCertificateName')
        - name: target.sshPublicKeyId
          expr: get_json_object(raw.requestParameters, '$.sshPublicKeyId')
        - name: target.userName
          expr: get_json_object(raw.requestParameters, '$.userName')
        - name: target.versionId
          expr: get_json_object(raw.requestParameters, '$.versionId')


    - name: aws_cloudtrail_user_access
      filter: | 
        raw.eventName in (
          'AttachUserPolicy', 'DetachUserPolicy', 'PutUserPolicy', 'DeleteUserPolicy', 'PutUserPermissionsBoundary', 'DeleteUserPermissionsBoundary'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
              from_json(raw.userIdentity, 'STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>')
          - name: tlsDetails
            expr: "from_json(raw.tlsDetails, 'STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>')"
          - name: addendum
            expr: "from_json(raw.addendum, 'STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>')"
          - name: resources
            expr: "from_json(raw.resources, 'ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>')"
      fields:
        - name: time
          from: time
        - name: eventTime
          from: raw.eventTime
        - name: eventName
          from: raw.eventName
        - name: eventCategory
          from: raw.eventCategory
        - name: eventType
          from: raw.eventType
        - name: eventSource
          from: raw.eventSource
        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          from: raw.awsRegion
        - name: sourceIPAddress
          from: raw.sourceIPAddress
        - name: userAgent
          from: raw.userAgent
        - name: errorCode
          from: raw.errorCode
        - name: errorMessage
          from: raw.errorMessage
        - name: requestParameters
          from: raw.requestParameters
        - name: responseElements
          from: raw.responseElements
        - name: additionalEventData
          from: raw.additionalEventData
        - name: requestID
          from: raw.requestID
        - name: eventID
          from: raw.eventID
        - name: apiVersion
          from: raw.apiVersion
        - name: managementEvent
          from: raw.managementEvent
        - name: readOnly
          expr: CAST(raw.readOnly AS BOOLEAN) 
        - name: eventVersion
          from: raw.eventVersion
        - name: recipientAccountId
          from: raw.recipientAccountId
        - name: serviceEventDetails
          from: raw.serviceEventDetails
        - name: sharedEventID
          from: raw.sharedEventID
        - name: vpcEndpointId
          from: raw.vpcEndpointId
        - name: vpcEndpointAccountId
          from: raw.vpcEndpointAccountId
        - name: sessionCredentialFromConsole
          from: raw.sessionCredentialFromConsole
        - name: edgeDeviceDetails
          from: raw.edgeDeviceDetails
        - name: resources
          from: resources
        - name: target.permissionsBoundary
          expr: get_json_object(raw.requestParameters, '$.permissionsBoundary')
        - name: target.policyArn
          expr: get_json_object(raw.requestParameters, '$.policyArn')
        - name: target.policyName
          expr: get_json_object(raw.requestParameters, '$.policyName')
        - name: target.policyDocument
          expr: get_json_object(raw.requestParameters, '$.policyDocument')
        - name: target.userName
          expr: get_json_object(raw.requestParameters, '$.userName')


    - name: aws_cloudtrail_group_management
      filter: | 
        raw.eventName in (
          'CreateGroup', 'DeleteGroup', 'UpdateGroup', 'AddUserToGroup', 'RemoveUserFromGroup', 'AttachGroupPolicy', 'DetachGroupPolicy', 'PutGroupPolicy', 'DeleteGroupPolicy'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
              from_json(raw.userIdentity, 'STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>')
          - name: tlsDetails
            expr: "from_json(raw.tlsDetails, 'STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>')"
          - name: addendum
            expr: "from_json(raw.addendum, 'STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>')"
          - name: resources
            expr: "from_json(raw.resources, 'ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>')"
      fields:
        - name: time
          from: time
        - name: eventTime
          from: raw.eventTime
        - name: eventName
          from: raw.eventName
        - name: eventCategory
          from: raw.eventCategory
        - name: eventType
          from: raw.eventType
        - name: eventSource
          from: raw.eventSource
        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          from: raw.awsRegion
        - name: sourceIPAddress
          from: raw.sourceIPAddress
        - name: userAgent
          from: raw.userAgent
        - name: errorCode
          from: raw.errorCode
        - name: errorMessage
          from: raw.errorMessage
        - name: requestParameters
          from: raw.requestParameters
        - name: responseElements
          from: raw.responseElements
        - name: additionalEventData
          from: raw.additionalEventData
        - name: requestID
          from: raw.requestID
        - name: eventID
          from: raw.eventID
        - name: apiVersion
          from: raw.apiVersion
        - name: managementEvent
          from: raw.managementEvent
        - name: readOnly
          expr: CAST(raw.readOnly AS BOOLEAN) 
        - name: eventVersion
          from: raw.eventVersion
        - name: recipientAccountId
          from: raw.recipientAccountId
        - name: serviceEventDetails
          from: raw.serviceEventDetails
        - name: sharedEventID
          from: raw.sharedEventID
        - name: vpcEndpointId
          from: raw.vpcEndpointId
        - name: vpcEndpointAccountId
          from: raw.vpcEndpointAccountId
        - name: sessionCredentialFromConsole
          from: raw.sessionCredentialFromConsole
        - name: edgeDeviceDetails
          from: raw.edgeDeviceDetails
        - name: resources
          from: resources
        - name: target.groupName
          expr: get_json_object(raw.requestParameters, '$.groupName')
        - name: target.newGroupName
          expr: get_json_object(raw.requestParameters, '$.newGroupName')
        - name: target.newPath
          expr: get_json_object(raw.requestParameters, '$.newPath')
        - name: target.path
          expr: get_json_object(raw.requestParameters, '$.path')
        - name: target.policyArn
          expr: get_json_object(raw.requestParameters, '$.policyArn')
        - name: target.policyDocument
          expr: get_json_object(raw.requestParameters, '$.policyDocument')
        - name: target.policyName
          expr: get_json_object(raw.requestParameters, '$.policyName')
        - name: target.userName
          expr: get_json_object(raw.requestParameters, '$.userName')


    - name: aws_cloudtrail_api_activity
      filter: | 
        raw.eventName in (
          'GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails', 'GetCredentialReport', 'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus', 'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy', 'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders', 'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases', 'SetSecurityTokenServicePreferences', 'SimulateCustomPolicy', 'SimulatePrincipalPolicy'
        )
      utils:
        unreferencedColumns:
          preserve: true
        temporaryFields:
          - name: userIdentity
            expr: | 
              from_json(raw.userIdentity, 'STRUCT<accessKeyId: STRING, accountId: STRING, arn: STRING, invokedBy: STRING, onBehalfOf: STRUCT<userId: STRING, identityStoreArn: STRING>, inScopeOf: STRUCT<sourceArn: STRING, sourceAccount: STRING, issuerType: STRING, credentialsIssuedTo: STRING>, credentialId: STRING, principalId: STRING, identityProvider: STRING, sessionContext: STRUCT<attributes: STRUCT<creationDate: STRING, mfaAuthenticated: STRING>, ec2RoleDelivery: STRING, webIdFederationData: STRUCT<federatedProvider: STRING, attributes: MAP<STRING, STRING>>, sessionIssuer: STRUCT<accountId: STRING, arn: STRING, principalId: STRING, type: STRING, userName: STRING>>, type: STRING, userName: STRING, assumedRoot: STRING, sourceIdentity: STRING>')
          - name: tlsDetails
            expr: "from_json(raw.tlsDetails, 'STRUCT<cipherSuite: STRING, clientProvidedHostHeader: STRING, tlsVersion: STRING>')"
          - name: addendum
            expr: "from_json(raw.addendum, 'STRUCT<reason: STRING, updatedFields: STRING, originalRequestID: STRING, originalEventID: STRING>')"
          - name: resources
            expr: "from_json(raw.resources, 'ARRAY<STRUCT<ARN: STRING, accountId: STRING, type: STRING>>')"
      fields:
        - name: time
          from: time
        - name: eventTime
          from: raw.eventTime
        - name: eventName
          from: raw.eventName
        - name: eventCategory
          from: raw.eventCategory
        - name: eventType
          from: raw.eventType
        - name: eventSource
          from: raw.eventSource
        - name: userIdentity
          from: userIdentity
        - name: tlsDetails
          from: tlsDetails
        - name: addendum
          from: addendum
        - name: awsRegion
          from: raw.awsRegion
        - name: sourceIPAddress
          from: raw.sourceIPAddress
        - name: userAgent
          from: raw.userAgent
        - name: errorCode
          from: raw.errorCode
        - name: errorMessage
          from: raw.errorMessage
        - name: requestParameters
          from: raw.requestParameters
        - name: responseElements
          from: raw.responseElements
        - name: additionalEventData
          from: raw.additionalEventData
        - name: requestID
          from: raw.requestID
        - name: eventID
          from: raw.eventID
        - name: apiVersion
          from: raw.apiVersion
        - name: managementEvent
          from: raw.managementEvent
        - name: readOnly
          expr: CAST(raw.readOnly AS BOOLEAN) 
        - name: eventVersion
          from: raw.eventVersion
        - name: recipientAccountId
          from: raw.recipientAccountId
        - name: serviceEventDetails
          from: raw.serviceEventDetails
        - name: sharedEventID
          from: raw.sharedEventID
        - name: vpcEndpointId
          from: raw.vpcEndpointId
        - name: vpcEndpointAccountId
          from: raw.vpcEndpointAccountId
        - name: sessionCredentialFromConsole
          from: raw.sessionCredentialFromConsole
        - name: edgeDeviceDetails
          from: raw.edgeDeviceDetails
        - name: resources
          from: resources
        - name: target.userName
          expr: get_json_object(raw.requestParameters, '$.userName')


gold:
  - name: account_change
    input: aws_cloudtrail_account_change
    filter: eventName IN ('CreateUser', 'CreateLoginProfile', 'DeleteUser', 'DeleteLoginProfile', 'ChangePassword', 'UpdateLoginProfile', 'ResetServiceSpecificCredential', 'AttachRolePolicy', 'PutRolePolicy', 'PutRolePermissionsBoundary',
                          'DetachRolePolicy', 'DeleteRolePolicy', 'DeleteRolePermissionsBoundary', 'EnableMFADevice', 'DeactivateMFADevice', 'DeleteVirtualMFADevice', 'UpdateUser', 'CreateVirtualMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey',
                          'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'UpdateServiceSpecificCredential',
                          'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole')
    fields:
      - name: action
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 'Allowed'
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Denied'
            ELSE 'Unknown'
          END
      - name: action_id
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 1
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 2
            ELSE 0
          END
      - name: activity_id
        expr: |
          CASE
            WHEN eventName IN ('CreateUser', 'CreateLoginProfile') THEN 1
            WHEN eventName IN ('DeleteUser', 'DeleteLoginProfile') THEN 6
            WHEN eventName IN ('ChangePassword', 'UpdateLoginProfile') THEN 3
            WHEN eventName IN ('ResetServiceSpecificCredential') THEN 4
            WHEN eventName in ('AttachRolePolicy', 'PutRolePolicy', 'PutRolePermissionsBoundary')  THEN 7 
            WHEN eventName in ('DetachRolePolicy', 'DeleteRolePolicy', 'DeleteRolePermissionsBoundary')  THEN 8 
            WHEN eventName in ('EnableMFADevice') THEN 10
            WHEN eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') THEN 11
            WHEN eventName IN ('UpdateUser', 'CreateVirtualMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole') THEN 99
            ELSE 0
          END
      - name: activity_name
        expr: |
          CASE
            WHEN eventName IN ('CreateUser', 'CreateLoginProfile') THEN 'Create'
            WHEN eventName IN ('DeleteUser', 'DeleteLoginProfile') THEN 'Delete'
            WHEN eventName IN ('ChangePassword', 'UpdateLoginProfile') THEN 'Password Change'
            WHEN eventName IN ('ResetServiceSpecificCredential') THEN 'Password Reset'
            WHEN eventName in ('AttachRolePolicy', 'PutRolePolicy', 'PutRolePermissionsBoundary')  THEN 'Attach Policy' 
            WHEN eventName in ('DetachRolePolicy', 'DeleteRolePolicy', 'DeleteRolePermissionsBoundary')  THEN 'Detach Policy' 
            WHEN eventName in ('EnableMFADevice') THEN 'MFA Factor Enable'
            WHEN eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') THEN 'MFA Factor Disable'
            WHEN eventName IN ('UpdateUser', 'CreateVirtualMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole') THEN eventName
            ELSE 'Unknown'
          END
      - name: category_name
        literal: Identity & Access Management 
      - name: category_uid
        expr: CAST(3 as INT)
      - name: class_name
        literal: Account Change
      - name: class_uid
        expr: CAST(3001 as INT)
      - name: disposition
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 'Blocked'
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 'Rejected'
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Unauthorized'
            WHEN errorCode IS NOT NULL THEN 'Error'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 2
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 25
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 26
            WHEN errorCode IS NOT NULL THEN 27
            ELSE 1
          END
      - name: metadata.uid
        from: eventID
      - name: metadata.event_code
        from: eventName
      - name: metadata.log_provider
        literal: AWS
      - name: metadata.log_name
        literal: CloudTrail
      - name: metadata.original_time
        from: eventTime
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        expr: eventTime::TIMESTAMP
      - name: metadata.log_level
        literal: Informational
      - name: raw_data
        expr: parse_json(requestParameters)
      - name: src_endpoint.ip
        from: sourceIPAddress
      - name: src_endpoint.uid
        from: vpcEndpointId
      - name: time
        from: time
      - name: type_name
        expr: |
          CASE
            WHEN eventName IN ('CreateUser', 'CreateLoginProfile') THEN 'Account Change: Create'
            WHEN eventName IN ('DeleteUser', 'DeleteLoginProfile') THEN 'Account Change: Delete'
            WHEN eventName IN ('ChangePassword', 'UpdateLoginProfile') THEN 'Account Change: Password Change'
            WHEN eventName IN ('ResetServiceSpecificCredential') THEN 'Account Change: Password Reset'
            WHEN eventName in ('AttachRolePolicy', 'PutRolePolicy', 'PutRolePermissionsBoundary')  THEN 'Account Change: Attach Policy' 
            WHEN eventName in ('DetachRolePolicy', 'DeleteRolePolicy', 'DeleteRolePermissionsBoundary')  THEN 'Account Change: Detach Policy' 
            WHEN eventName in ('EnableMFADevice') THEN 'Account Change: MFA Factor Enable'
            WHEN eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') THEN 'Account Change: MFA Factor Disable'
            WHEN eventName IN ('UpdateUser', 'CreateVirtualMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole') THEN 'Account Change: Other'
            ELSE 'Account Change: Unknown'
          END
      - name: type_uid
        expr: |
          CASE
            WHEN eventName IN ('CreateUser', 'CreateLoginProfile') THEN 300101::BIGINT
            WHEN eventName IN ('DeleteUser', 'DeleteLoginProfile') THEN 300106::BIGINT
            WHEN eventName IN ('ChangePassword', 'UpdateLoginProfile') THEN 300103::BIGINT
            WHEN eventName IN ('ResetServiceSpecificCredential') THEN 300104::BIGINT
            WHEN eventName in ('AttachRolePolicy', 'PutRolePolicy', 'PutRolePermissionsBoundary')  THEN 300107::BIGINT
            WHEN eventName in ('DetachRolePolicy', 'DeleteRolePolicy', 'DeleteRolePermissionsBoundary')  THEN 300108::BIGINT
            WHEN eventName in ('EnableMFADevice') THEN 300110::BIGINT
            WHEN eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') THEN 300111::BIGINT
            WHEN eventName IN ('UpdateUser', 'CreateVirtualMFADevice', 'ResyncMFADevice', 'UpdateSSHPublicKey', 'UploadSSHPublicKey', 'DeleteSSHPublicKey', 'UploadSigningCertificate', 'DeleteSigningCertificate', 'UpdateSigningCertificate', 'CreateServiceSpecificCredential', 'DeleteServiceSpecificCredential', 'UpdateServiceSpecificCredential', 'CreateAccessKey', 'DeleteAccessKey', 'UpdateAccessKey', 'CreateAccountAlias', 'DeleteAccountAlias', 'UpdateAccountPasswordPolicy', 'DeleteAccountPasswordPolicy', 'TagUser', 'UntagUser', 'TagRole', 'UntagRole') THEN 300199::BIGINT
            ELSE 300100::BIGINT
          END
      - name: user.name
        expr: target.userName
      - name: unmapped
        expr: | 
          CAST(to_json(named_struct(
            'eventVersion', eventVersion,
            'userIdentity', userIdentity,
            'eventSource', eventSource,
            'additionalEventData', additionalEventData,
            'sharedEventID', sharedEventID,
            'eventType', eventType,
            'managementEvent', managementEvent,
            'readOnly', readOnly,
            'resources', resources,
            'recipientAccountId', recipientAccountId,
            'serviceEventDetails', serviceEventDetails,
            'vpcEndpointAccountId', vpcEndpointAccountId,
            'eventCategory', eventCategory,
            'addendum', addendum,
            'sessionCredentialFromConsole', sessionCredentialFromConsole,
            'edgeDeviceDetails', edgeDeviceDetails,
            'tlsDetails', tlsDetails
          )) AS VARIANT)

  - name: entity_management
    input: aws_cloudtrail_entity_management
    filter: eventName IN ('CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider',
                          'CreateServiceLinkedRole', 'UploadServerCertificate', 'GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole',
                          'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate',
                          'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 
                          'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 
                          'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 
                          'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices',
                          'TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate',
                          'DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole',
                          'EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions', 'DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions')
    fields:
      - name: action
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 'Allowed'
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Denied'
            ELSE 'Unknown'
          END
      - name: action_id
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 1
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 2
            ELSE 0
          END

      - name: activity_id
        expr: |
          CASE
            WHEN eventName IN ('CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider', 'CreateServiceLinkedRole', 'UploadServerCertificate') THEN 1
            WHEN eventName IN ('GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole', 'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate', 'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices') THEN 2

            WHEN eventName IN ('TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate') THEN 3

            WHEN eventName IN ('DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole') THEN 4

            WHEN eventName IN ('EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions') THEN 8
            WHEN eventName IN ('DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions') THEN 9
            ELSE 0
          END
      - name: activity_name
        expr: |
          CASE
            WHEN eventName IN ('CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider', 'CreateServiceLinkedRole', 'UploadServerCertificate') THEN 'Create'

            WHEN eventName IN ('GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole', 'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate', 'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices') THEN 'Read'

            WHEN eventName IN ('TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate') THEN 'Update'

            WHEN eventName IN ('DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole') THEN 'Delete'

            WHEN eventName IN ('EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions') THEN 'Enable'
            WHEN eventName IN ('DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions') THEN 'Disable'
            ELSE 'Unknown'
          END
      - name: category_name
        literal: Identity & Access Management 
      - name: category_uid
        expr: CAST(3 as INT)
      - name: class_name
        literal: Entity Management
      - name: class_uid
        expr: CAST(3004 as INT)
      - name: disposition
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 'Blocked'
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 'Rejected'
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Unauthorized'
            WHEN errorCode IS NOT NULL THEN 'Error'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 2
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 25
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 26
            WHEN errorCode IS NOT NULL THEN 27
            ELSE 1
          END

      - name: metadata.uid
        from: eventID
      - name: metadata.event_code
        from: eventName
      - name: metadata.log_provider
        literal: AWS
      - name: metadata.log_name
        literal: CloudTrail
      - name: metadata.original_time
        from: eventTime
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        expr: eventTime::TIMESTAMP
      - name: metadata.log_level
        literal: Informational
      - name: raw_data
        expr: parse_json(requestParameters)
      - name: status
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 'Success'
            ELSE 'Failure'
          END
      - name: status_id
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 1
            ELSE 2
          END
      - name: time
        from: time
      - name: type_name
        expr: |
          CASE
            WHEN eventName IN ('CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider', 'CreateServiceLinkedRole', 'UploadServerCertificate') THEN 'Entity Management: Create'

            WHEN eventName IN ('GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole', 'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate', 'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices') THEN 'Entity Management: Read'

            WHEN eventName IN ('TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate') THEN 'Entity Management: Update'

            WHEN eventName IN ('DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole') THEN 'Entity Management: Delete'

            WHEN eventName IN ('EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions') THEN 'Entity Management: Enable'
            WHEN eventName IN ('DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions') THEN 'Entity Management: Disable'
            ELSE 'Entity Management: Unknown'
          END
      - name: type_uid
        expr: |
          CASE
            WHEN eventName IN ('CreateInstanceProfile', 'CreateOpenIDConnectProvider', 'CreatePolicy', 'CreatePolicyVersion', 'CreateRole', 'CreateSAMLProvider', 'CreateServiceLinkedRole', 'UploadServerCertificate') THEN 300401::BIGINT

            WHEN eventName IN ('GetGroup', 'GetGroupPolicy', 'GetUser', 'GetUserPolicy', 'GetRole', 'GetRolePolicy', 'GetPolicy', 'GetPolicyVersion', 'GetInstanceProfile', 'GetLoginProfile', 'GetOpenIDConnectProvider', 'GetSAMLProvider', 'GetServerCertificate', 'ListUserTags', 'ListGroupsForUser', 'ListRoleTags', 'ListInstanceProfilesForRole', 'ListInstanceProfileTags', 'ListSAMLProviderTags', 'ListOpenIDConnectProviderTags', 'ListServerCertificateTags', 'ListMFADevices', 'ListMFADeviceTags', 'ListSigningCertificates', 'ListSSHPublicKeys', 'ListServiceSpecificCredentials', 'ListPolicyVersions', 'ListPolicyTags', 'ListEntitiesForPolicy', 'ListAttachedUserPolicies', 'ListAttachedGroupPolicies', 'ListAttachedRolePolicies', 'GetMFADevice', 'ListAccessKeys', 'ListGroupPolicies', 'ListOrganizationsFeatures', 'ListRolePolicies', 'ListUserPolicies', 'ListVirtualMFADevices') THEN 300402::BIGINT

            WHEN eventName IN ('TagMFADevice', 'UntagMFADevice', 'TagOpenIDConnectProvider', 'UntagOpenIDConnectProvider', 'TagSAMLProvider', 'UntagSAMLProvider', 'TagServerCertificate', 'UntagServerCertificate', 'SetDefaultPolicyVersion', 'TagPolicy', 'UntagPolicy', 'TagInstanceProfile', 'UntagInstanceProfile', 'AddClientIDToOpenIDConnectProvider', 'AddRoleToInstanceProfile', 'RemoveClientIDFromOpenIDConnectProvider', 'RemoveRoleFromInstanceProfile', 'UpdateAssumeRolePolicy', 'UpdateOpenIDConnectProviderThumbprint', 'UpdateRole', 'UpdateRoleDescription', 'UpdateSAMLProvider', 'UpdateServerCertificate') THEN 300403::BIGINT

            WHEN eventName IN ('DeleteInstanceProfile', 'DeleteOpenIDConnectProvider', 'DeletePolicy', 'DeletePolicyVersion', 'DeleteRole', 'DeleteSAMLProvider', 'DeleteServerCertificate', 'DeleteServiceLinkedRole') THEN 300404::BIGINT

            WHEN eventName IN ('EnableOrganizationsRootCredentialsManagement', 'EnableOrganizationsRootSessions') THEN 300408::BIGINT
            WHEN eventName IN ('DisableOrganizationsRootCredentialsManagement', 'DisableOrganizationsRootSessions') THEN 300409::BIGINT
            ELSE 300400::BIGINT
          END

      - name: unmapped
        expr: | 
          CAST(to_json(named_struct(
            'eventVersion', eventVersion,
            'userIdentity', userIdentity,
            'eventSource', eventSource,
            'additionalEventData', additionalEventData,
            'sharedEventID', sharedEventID,
            'eventType', eventType,
            'managementEvent', managementEvent,
            'readOnly', readOnly,
            'resources', resources,
            'recipientAccountId', recipientAccountId,
            'serviceEventDetails', serviceEventDetails,
            'vpcEndpointAccountId', vpcEndpointAccountId,
            'eventCategory', eventCategory,
            'addendum', addendum,
            'sessionCredentialFromConsole', sessionCredentialFromConsole,
            'edgeDeviceDetails', edgeDeviceDetails,
            'tlsDetails', tlsDetails
          )) AS VARIANT)

  - name: user_access
    input: aws_cloudtrail_user_access
    filter: eventName IN ('AttachUserPolicy', 'PutUserPolicy', 'PutUserPermissionsBoundary', 'DetachUserPolicy', 'DeleteUserPolicy', 'DeleteUserPermissionsBoundary')
    fields:
      - name: action
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 'Allowed'
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Denied'
            ELSE 'Unknown'
          END
      - name: action_id
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 1
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 2
            ELSE 0
          END
      - name: activity_id
        expr: |
          CASE
            WHEN eventName in ('AttachUserPolicy', 'PutUserPolicy', 'PutUserPermissionsBoundary')  THEN 1
            WHEN eventName in ('DetachUserPolicy', 'DeleteUserPolicy', 'DeleteUserPermissionsBoundary')  THEN 2         
            ELSE 0
          END
      - name: activity_name
        expr: |
          CASE
            WHEN eventName in ('AttachUserPolicy', 'PutUserPolicy', 'PutUserPermissionsBoundary')  THEN 'Assign Privileges'
            WHEN eventName in ('DetachUserPolicy', 'DeleteUserPolicy', 'DeleteUserPermissionsBoundary')  THEN 'Revoke Privileges'
            ELSE 'Unknown'
          END
      - name: category_name
        literal: Identity & Access Management 
      - name: category_uid
        expr: CAST(3 as INT)
      - name: class_name
        literal: User Access Management
      - name: class_uid
        expr: CAST(3005 as INT)
      - name: disposition
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 'Blocked'
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 'Rejected'
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Unauthorized'
            WHEN errorCode IS NOT NULL THEN 'Error'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 2
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 25
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 26
            WHEN errorCode IS NOT NULL THEN 27
            ELSE 1
          END

      - name: metadata.uid
        from: eventID
      - name: metadata.event_code
        from: eventName
      - name: metadata.log_provider
        literal: AWS
      - name: metadata.log_name
        literal: CloudTrail
      - name: metadata.original_time
        from: eventTime
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        expr: eventTime::TIMESTAMP
      - name: metadata.log_level
        literal: Informational

      - name: privileges
        expr: | 
          CASE
            WHEN eventName in ('AttachUserPolicy') THEN array(target.policyArn)
            ELSE array()
          END
      - name: raw_data
        expr: parse_json(requestParameters)
      - name: resource.name
        from: target.userName
      - name: src_endpoint.ip
        from: sourceIPAddress
      - name: src_endpoint.uid
        from: vpcEndpointId
      - name: status
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 'Success'
            ELSE 'Failure'
          END
      - name: status_id
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 1
            ELSE 2
          END
      - name: time
        from: time
      - name: type_name
        expr: |
          CASE
            WHEN eventName in ('AttachUserPolicy', 'PutUserPolicy', 'PutUserPermissionsBoundary')  THEN 'User Access Management: Assign Privileges'
            WHEN eventName in ('DetachUserPolicy', 'DeleteUserPolicy', 'DeleteUserPermissionsBoundary')  THEN 'User Access Management: Revoke Privileges'
            ELSE 'Account Change: Unknown'
          END
      - name: type_uid
        expr: |
          CASE
            WHEN eventName in ('AttachUserPolicy', 'PutUserPolicy', 'PutUserPermissionsBoundary')  THEN 300501::BIGINT
            WHEN eventName in ('DetachUserPolicy', 'DeleteUserPolicy', 'DeleteUserPermissionsBoundary')  THEN 300502::BIGINT
            ELSE 300500
          END
      - name: unmapped
        expr: | 
          CAST(to_json(named_struct(
            'eventVersion', eventVersion,
            'userIdentity', userIdentity,
            'eventSource', eventSource,
            'additionalEventData', additionalEventData,
            'sharedEventID', sharedEventID,
            'eventType', eventType,
            'managementEvent', managementEvent,
            'readOnly', readOnly,
            'resources', resources,
            'recipientAccountId', recipientAccountId,
            'serviceEventDetails', serviceEventDetails,
            'vpcEndpointAccountId', vpcEndpointAccountId,
            'eventCategory', eventCategory,
            'addendum', addendum,
            'sessionCredentialFromConsole', sessionCredentialFromConsole,
            'edgeDeviceDetails', edgeDeviceDetails,
            'tlsDetails', tlsDetails
          )) AS VARIANT)
      - name: user.name
        expr: target.userName

  - name: group_management
    input: aws_cloudtrail_group_management
    filter: eventName IN ('AttachGroupPolicy', 'PutGroupPolicy', 'DetachGroupPolicy', 'DeleteGroupPolicy', 'AddUserToGroup', 'RemoveUserFromGroup', 'DeleteGroup', 'CreateGroup', 'UpdateGroup')
    fields:
      - name: action
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 'Allowed'
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Denied'
            ELSE 'Unknown'
          END
      - name: action_id
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 1
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 2
            ELSE 0
          END
      - name: activity_id
        expr: |
          CASE
            WHEN eventName in ('AttachGroupPolicy', 'PutGroupPolicy')  THEN 1
            WHEN eventName in ('DetachGroupPolicy', 'DeleteGroupPolicy')  THEN 2 
            WHEN eventName in ('AddUserToGroup') THEN 3
            WHEN eventName in ('RemoveUserFromGroup') THEN 4
            WHEN eventName in ('DeleteGroup') THEN 5
            WHEN eventName in ('CreateGroup') THEN 6
            WHEN eventName in ('UpdateGroup') THEN 99
            ELSE 0
          END
      - name: activity_name
        expr: |
          CASE
            WHEN eventName in ('AttachGroupPolicy', 'PutGroupPolicy') THEN 'Assign Privileges'
            WHEN eventName in ('DetachGroupPolicy', 'DeleteGroupPolicy') THEN 'Revoke Privileges'
            WHEN eventName in ('AddUserToGroup') THEN 'Add User'
            WHEN eventName in ('RemoveUserFromGroup') THEN 'Remove User'
            WHEN eventName in ('DeleteGroup') THEN 'Delete'
            WHEN eventName in ('CreateGroup') THEN 'Create'
            WHEN eventName in ('UpdateGroup') THEN 'Other'
            ELSE 'Unknown'
          END

      - name: category_name
        literal: Identity & Access Management 
      - name: category_uid
        expr: CAST(3 as INT)
      - name: class_name
        literal: Group Management
      - name: class_uid
        expr: CAST(3006 as INT)
      - name: cloud.account.uid
        from: userIdentity.accountId
      - name: cloud.cloud_partition
        expr: | 
          CASE 
            WHEN awsRegion IN ('us-gov-east-1', 'us-gov-west-1') THEN 'aws-us-gov'
            WHEN awsRegion IN ('cn-north-1', 'cn-northwest-1') THEN 'aws-cn'
            WHEN awsRegion IN ('us-iso-east-1', 'us-iso-west-1') THEN 'aws-iso'
            WHEN awsRegion IN ('us-isob-east-1') THEN 'aws-iso-b'
            WHEN awsRegion IN ('us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'af-south-1', 'ap-east-1', 'ap-south-1', 'ap-south-2', 'ap-southeast-1', 'ap-southeast-2', 'ap-southeast-3', 'ap-southeast-4', 'ap-southeast-5', 'ap-southeast-7', 'ap-northeast-1', 'ap-northeast-2', 'ap-northeast-3', 'ca-central-1', 'ca-west-1', 'eu-central-1', 'eu-central-2', 'eu-north-1', 'eu-south-1', 'eu-south-2', 'eu-west-1', 'eu-west-2', 'eu-west-3', 'il-central-1', 'mx-central-1', 'me-central-1', 'me-south-1', 'sa-east-1') THEN 'aws'
            ELSE NULL
          END
      - name: cloud.provider
        literal: AWS
      - name: cloud.region
        from: awsRegion
      - name: disposition
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 'Blocked'
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 'Rejected'
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Unauthorized'
            WHEN errorCode IS NOT NULL THEN 'Error'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 2
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 25
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 26
            WHEN errorCode IS NOT NULL THEN 27
            ELSE 1
          END
      - name: metadata.uid
        from: eventID
      - name: metadata.event_code
        from: eventName
      - name: metadata.log_provider
        literal: AWS
      - name: metadata.log_name
        literal: CloudTrail
      - name: metadata.original_time
        from: eventTime
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        expr: eventTime::TIMESTAMP
      - name: metadata.log_level
        literal: Informational
      - name: privileges
        expr: | 
          CASE
            WHEN eventName in ('AttachUserPolicy') THEN array(target.policyArn)
            ELSE array()
          END
      - name: raw_data
        expr: parse_json(requestParameters)
      - name: resource.name
        from: target.userName
      - name: src_endpoint.ip
        from: sourceIPAddress
      - name: src_endpoint.uid
        from: vpcEndpointId
      - name: status
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 'Success'
            ELSE 'Failure'
          END
      - name: status_id
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 1
            ELSE 2
          END
      - name: time
        from: time
      - name: type_name
        expr: |
          CASE
            WHEN eventName in ('AttachGroupPolicy', 'PutGroupPolicy') THEN 'Group Management: Assign Privileges'
            WHEN eventName in ('DetachGroupPolicy', 'DeleteGroupPolicy') THEN 'Group Management: Revoke Privileges'
            WHEN eventName in ('AddUserToGroup') THEN 'Group Management: Add User'
            WHEN eventName in ('RemoveUserFromGroup') THEN 'Group Management: Remove User'
            WHEN eventName in ('DeleteGroup') THEN 'Group Management: Delete'
            WHEN eventName in ('CreateGroup') THEN 'Group Management: Create'
            WHEN eventName in ('UpdateGroup') THEN 'Group Management: Other'
            ELSE 'Group Management: Unknown'
          END
      - name: type_uid
        expr: |
          CASE
            WHEN eventName in ('AttachGroupPolicy', 'PutGroupPolicy') THEN 300601::BIGINT
            WHEN eventName in ('DetachGroupPolicy', 'DeleteGroupPolicy') THEN 300602::BIGINT
            WHEN eventName in ('AddUserToGroup') THEN 300603::BIGINT
            WHEN eventName in ('RemoveUserFromGroup') THEN 300604::BIGINT
            WHEN eventName in ('DeleteGroup') THEN 300605::BIGINT
            WHEN eventName in ('CreateGroup') THEN 300606::BIGINT
            WHEN eventName in ('UpdateGroup') THEN 300699::BIGINT
            ELSE 300600::BIGINT
          END
      - name: unmapped
        expr: | 
          CAST(to_json(named_struct(
            'eventVersion', eventVersion,
            'userIdentity', userIdentity,
            'eventSource', eventSource,
            'additionalEventData', additionalEventData,
            'sharedEventID', sharedEventID,
            'eventType', eventType,
            'managementEvent', managementEvent,
            'readOnly', readOnly,
            'resources', resources,
            'recipientAccountId', recipientAccountId,
            'serviceEventDetails', serviceEventDetails,
            'vpcEndpointAccountId', vpcEndpointAccountId,
            'eventCategory', eventCategory,
            'addendum', addendum,
            'sessionCredentialFromConsole', sessionCredentialFromConsole,
            'edgeDeviceDetails', edgeDeviceDetails,
            'tlsDetails', tlsDetails
          )) AS VARIANT)
      - name: user.name
        expr: target.userName

  - name: api_activity
    input: aws_cloudtrail_api_activity
    filter: eventName in ('GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails', 'GetCredentialReport',
          'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus',
          'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy',
          'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders',
          'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases', 'SetSecurityTokenServicePreferences', 'SimulateCustomPolicy',
          'SimulatePrincipalPolicy')
    fields:
      - name: action
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 'Allowed'
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Denied'
            ELSE 'Unknown'
          END
      - name: action_id
        expr: |
          CASE
            WHEN errorCode IS NULL THEN 1
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException', 'AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 2
            ELSE 0
          END
      - name: activity_id
        expr: |
          CASE
            WHEN eventName in ('GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails')  THEN 1
            WHEN eventName in ('GetCredentialReport', 'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus', 'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy', 'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders', 'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases')  THEN 2 
            WHEN eventName in ('SetSecurityTokenServicePreferences') THEN 3
            WHEN eventName in ('SimulateCustomPolicy', 'SimulatePrincipalPolicy') THEN 99
            ELSE 0
          END
      - name: activity_name
        expr: |
          CASE
            WHEN eventName in ('GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails')  THEN 'Create'
            WHEN eventName in ('GetCredentialReport', 'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus', 'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy', 'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders', 'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases')  THEN 'Read' 
            WHEN eventName in ('SetSecurityTokenServicePreferences') THEN 'Update'
            WHEN eventName in ('SimulateCustomPolicy', 'SimulatePrincipalPolicy') THEN 'Simulate'
            ELSE 'Unknown'
          END
      
      - name: category_name
        literal: Application Activity 
      - name: category_uid
        expr: CAST(6 as INT)
      - name: class_name
        literal: API Activity
      - name: class_uid
        expr: CAST(6003 as INT)
      - name: cloud.account.uid
        from: userIdentity.accountId
      - name: cloud.cloud_partition
        expr: | 
          CASE 
            WHEN awsRegion IN ('us-gov-east-1', 'us-gov-west-1') THEN 'aws-us-gov'
            WHEN awsRegion IN ('cn-north-1', 'cn-northwest-1') THEN 'aws-cn'
            WHEN awsRegion IN ('us-iso-east-1', 'us-iso-west-1') THEN 'aws-iso'
            WHEN awsRegion IN ('us-isob-east-1') THEN 'aws-iso-b'
            WHEN awsRegion IN ('us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'af-south-1', 'ap-east-1', 'ap-south-1', 'ap-south-2', 'ap-southeast-1', 'ap-southeast-2', 'ap-southeast-3', 'ap-southeast-4', 'ap-southeast-5', 'ap-southeast-7', 'ap-northeast-1', 'ap-northeast-2', 'ap-northeast-3', 'ca-central-1', 'ca-west-1', 'eu-central-1', 'eu-central-2', 'eu-north-1', 'eu-south-1', 'eu-south-2', 'eu-west-1', 'eu-west-2', 'eu-west-3', 'il-central-1', 'mx-central-1', 'me-central-1', 'me-south-1', 'sa-east-1') THEN 'aws'
            ELSE NULL
          END
      - name: cloud.provider
        literal: AWS
      - name: cloud.region
        from: awsRegion
      - name: disposition
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 'Blocked'
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 'Rejected'
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 'Unauthorized'
            WHEN errorCode IS NOT NULL THEN 'Error'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CASE
            WHEN errorCode IN ('LimitExceeded', 'OptInRequired', 'ThrottlingException') THEN 2
            WHEN errorCode IN ('IncompleteSignature', 'InvalidAction', 'InvalidClientTokenId', 'ValidationException', 'ValidationError', 'ConcurrentModification') THEN 25
            WHEN errorCode IN ('AccessDenied', 'AccessDeniedException', 'InvalidAccessException', 'NotAuthorized') THEN 26
            WHEN errorCode IS NOT NULL THEN 27
            ELSE 1
          END
      - name: metadata.uid
        from: eventID
      - name: metadata.event_code
        from: eventName
      - name: metadata.log_provider
        literal: AWS
      - name: metadata.log_name
        literal: CloudTrail
      - name: metadata.original_time
        from: eventTime
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        expr: eventTime::TIMESTAMP
      - name: metadata.log_level
        literal: Informational
      - name: raw_data
        expr: parse_json(requestParameters)
      - name: src_endpoint.ip
        from: sourceIPAddress
      - name: src_endpoint.uid
        from: vpcEndpointId
      - name: status
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 'Success'
            ELSE 'Failure'
          END
      - name: status_id
        expr: | 
          CASE
            WHEN errorCode IS NULL THEN 1
            ELSE 2
          END
      - name: time
        from: time
      - name: type_name
        expr: |
          CASE
            WHEN eventName in ('GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails')  THEN 'API Activity: Create'
            WHEN eventName in ('GetCredentialReport', 'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus', 'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy', 'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders', 'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases')  THEN 'API Activity: Read' 
            WHEN eventName in ('SetSecurityTokenServicePreferences') THEN 'API Activity: Update'
            WHEN eventName in ('SimulateCustomPolicy', 'SimulatePrincipalPolicy') THEN 'API Activity: Other'
            ELSE 'Unknown'
          END
      - name: type_uid
        expr: |
          CASE
            WHEN eventName in ('GenerateCredentialReport', 'GenerateOrganizationsAccessReport', 'GenerateServiceLastAccessedDetails')  THEN 600301::BIGINT
            WHEN eventName in ('GetCredentialReport', 'GetOrganizationsAccessReport', 'GetServiceLastAccessedDetails', 'GetServiceLastAccessedDetailsWithEntities', 'GetServiceLinkedRoleDeletionStatus', 'GetAccountAuthorizationDetails', 'GetAccountSummary', 'GetAccountPasswordPolicy', 'GetAccessKeyLastUsed', 'GetSSHPublicKey', 'GetContextKeysForCustomPolicy', 'GetContextKeysForPrincipalPolicy', 'ListUsers', 'ListGroups', 'ListRoles', 'ListInstanceProfiles', 'ListSAMLProviders', 'ListOpenIDConnectProviders', 'ListServerCertificates', 'ListPolicies', 'ListPoliciesGrantingServiceAccess', 'ListAccountAliases')  THEN 600302::BIGINT
            WHEN eventName in ('SetSecurityTokenServicePreferences') THEN 600303::BIGINT
            WHEN eventName in ('SimulateCustomPolicy', 'SimulatePrincipalPolicy') THEN 600399::BIGINT
            ELSE 600300::BIGINT
          END
      - name: unmapped
        expr: | 
          CAST(to_json(named_struct(
            'eventVersion', eventVersion,
            'userIdentity', userIdentity,
            'eventSource', eventSource,
            'additionalEventData', additionalEventData,
            'sharedEventID', sharedEventID,
            'eventType', eventType,
            'managementEvent', managementEvent,
            'readOnly', readOnly,
            'resources', resources,
            'recipientAccountId', recipientAccountId,
            'serviceEventDetails', serviceEventDetails,
            'vpcEndpointAccountId', vpcEndpointAccountId,
            'eventCategory', eventCategory,
            'addendum', addendum,
            'sessionCredentialFromConsole', sessionCredentialFromConsole,
            'edgeDeviceDetails', edgeDeviceDetails,
            'tlsDetails', tlsDetails
          )) AS VARIANT)



