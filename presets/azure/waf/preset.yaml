name: azure_waf
author: Antimatter
description: "A preset for consuming logs generated by Azure WAF logs"
autoloader:
  format: json
  cloudFiles:
    schemaHints: "properties struct<Action:string,ActionReason:string,DestinationPort:int,Fqdn:string,IsExplicitProxyRequest:boolean,IsTlsInspected:boolean,Policy:string,Protocol:string,Rule:string,RuleCollection:string,RuleCollectionGroup:string,SourceIp:string,SourcePort:int,TargetUrl:string,WebCategory:string,DestinationIp:string,instanceId:string,clientIp:string,requestUri:string,ruleSetType:string,ruleSetVersion:string,ruleId:string,ruleGroup:string,message:string,clientPort:int,httpMethod:string,originalRequestUriWithArgs:string,requestQuery:string,Url:string,ThreatDescription:string,details:struct<message:string,data:string,file:string,line:string>,hostname:string,transactionId:string,policyId:string,policyScopt:string,policyScopeName:string,engine:string,policyScope:string,userAgent:string,contentType:string,error_info:string,httpStatus:int,httpVersion:string,receivedBytes:int,sentBytes:int,connectionSerialNumber:int,noOfConnectionRequests:int,clientResponseTime:float,timeTaken:float,WAFMode:string,WAFEvaluationTime:string,WAFPolicyID:string,sslEnabled:string,sslCipher:string,sslProtocol:string,sslClientVerify:string,sslClientCertificateFingerprint:string,sslClientCertificateIssuerName:string,serverRouted:string,serverStatus:string,serverResponseLatency:string,upstreamSourcePort:string,originalHost:string,host:string,msg:string,TranslatedIp:string,TranslatedPort:int,priority:int>,time timestamp,timeStamp timestamp,operationName string,listenerName string,ruleName string,backendPoolName string,backendSettingName string"
silver:
  transform:
    - name: azure_waf_application_gateway_access_log
      filter: "category = 'ApplicationGatewayAccessLog'"
      fields:
        - name: ocsf_activity_id
          expr: CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END
        - name: ocsf_activity_name
          expr: CASE WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 'Unknown' ELSE CONCAT(UPPER(SUBSTRING(properties.httpMethod, 1, 1)), LOWER(SUBSTRING(properties.httpMethod, 2))) END
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4002' AS INT)"
        - name: ocsf_class_name
          literal: HTTP Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST((400200 + CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END) AS BIGINT)
        - name: ocsf_type_name
          expr: "CONCAT('HTTP Activity: ', properties.httpMethod)"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: ocsf_http_request.args
          from: properties.originalRequestUriWithArgs
        - name: ocsf_http_request.length
          from: properties.receivedBytes
        - name: ocsf_http_request.http_method
          from: properties.httpMethod
        - name: ocsf_http_request.user_agent
          from: properties.userAgent
        - name: ocsf_http_request.version
          from: properties.httpVersion
        - name: ocsf_http_request.url.hostname
          expr: "COALESCE(properties.host, properties.originalHost)"
        - name: ocsf_http_request.url.port
          from: properties.clientPort
        - name: ocsf_http_request.url.query_string
          from: properties.requestQuery
        - name: ocsf_http_response.code
          from: properties.httpStatus
        - name: ocsf_http_response.latency
          expr: "CAST(CAST((CASE WHEN properties.serverResponseLatency = '' THEN '0.0' ELSE properties.serverResponseLatency END) AS FLOAT) AS INT)"
        - name: ocsf_http_response.length
          expr: CAST(properties.sentBytes AS INT)
        - name: ocsf_connection_info.session.count
          from: properties.noOfConnectionRequests
        - name: ocsf_connection_info.session.issuer
          from: properties.sslClientCertificateIssuerName
        - name: ocsf_tls.certificate.issuer
          from: properties.sslClientCertificateIssuerName
        - name: ocsf_tls.certificate.fingerprints
          expr: "array(named_struct('value', properties.sslClientCertificateFingerprint))"
        - name: ocsf_tls.version
          from: properties.sslProtocol
        - name: ocsf_traffic.bytes
          expr: "CAST((CASE WHEN properties.receivedBytes IS NOT NULL THEN properties.receivedBytes ELSE 0 END) + (CASE WHEN properties.sentBytes IS NOT NULL THEN properties.sentBytes ELSE 0 END) AS BIGINT)"
        - name: ocsf_traffic.bytes_in
          expr: CAST(properties.receivedBytes AS BIGINT)
        - name: ocsf_traffic.bytes_out
          expr: CAST(properties.sentBytes AS BIGINT)
        - name: r_clientIP
          expr: "CASE WHEN _rescued_data IS NOT NULL THEN from_json(_rescued_data, 'struct<properties:struct<clientIP:string>>') ELSE NULL END"
        - name: ocsf_src_endpoint.ip
          expr: "CASE WHEN _rescued_data IS NOT NULL THEN r_clientIP.properties.clientIP ELSE '' END"
        - name: ocsf_dst_endpoint.ip
          from: properties.originalHost
        - name: ocsf_firewall_rule.name
          from: ruleName
        - name: ocsf_firewall_rule.uid
          from: properties.WAFPolicyID
        - name: ocsf_firewall_rule.duration
          expr: "CAST(CAST((CASE WHEN properties.WAFEvaluationTime = '' THEN '0.0' ELSE properties.WAFEvaluationTime END) AS FLOAT) AS BIGINT)"
        - name: ocsf_firewall_rule.desc
          from: properties.WAFMode
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_azure_firewall_application_rule
      filter: "category = 'AzureFirewallApplicationRule'"
      fields:
        - name: ocsf_activity_id
          expr: CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END
        - name: ocsf_activity_name
          expr: CASE WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 'Unknown' ELSE CONCAT(UPPER(SUBSTRING(properties.httpMethod, 1, 1)), LOWER(SUBSTRING(properties.httpMethod, 2))) END
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4002' AS INT)"
        - name: ocsf_class_name
          literal: HTTP Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST((400200 + CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END) AS BIGINT)
        - name: ocsf_type_name
          expr: "CONCAT('HTTP Activity: ', properties.httpMethod)"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: raw_data
          from: properties.msg
        - name: re_protocol
          expr: CASE WHEN trim(regexp_extract(properties.msg, r'^(\w+)', 1)) IN ('HTTPS', 'HTTP') THEN regexp_extract(properties.msg, r'^(\w+)', 1) ELSE '' END
        - name: ocsf_connection_info.protocol_name
          expr: CASE WHEN trim(regexp_extract(properties.msg, r'^(\w+)', 1)) IN ('TCP', 'UDP') THEN regexp_extract(properties.msg, r'^(\w+)', 1) ELSE '' END
        - name: ocsf_connection_info.protocol_num
          expr: CASE WHEN trim(regexp_extract(properties.msg, r'^(\w+)', 1)) = 'TCP' THEN 6 WHEN regexp_extract(properties.msg, r'^(\w+)', 1) = 'UDP' THEN 17 ELSE null END
        - name: ocsf_src_endpoint.hostname
          expr: regexp_extract(properties.msg, r'from\s+([^:]+)', 1)
        - name: ocsf_src_endpoint.port
          expr: CAST(regexp_extract(properties.msg, r'from\s+[^:]+:(\d+)', 1) AS INT)
        - name: ocsf_src_endpoint.proxy_endpoint.hostname
          expr: regexp_extract(properties.msg, r"was DNAT'ed to\\s+([^:]+)", 1)
        - name: ocsf_src_endpoint.proxy_endpoint.port
          expr: CAST((CASE WHEN regexp_extract(properties.msg, r"was DNAT'ed to\\s+[^:]+:(\\d+)", 1) = '' THEN null ELSE regexp_extract(properties.msg, r"was DNAT'ed to\\s+[^:]+:(\\d+)", 1) END) AS INT)
        - name: ocsf_dst_endpoint.hostname
          expr: regexp_extract(properties.msg, r'to\s+([^:]+)', 1)
        - name: ocsf_dst_endpoint.port
          expr: CAST(regexp_extract(properties.msg, r'to\s+[^:]+:(\d+)', 1) AS INT)
        - name: action
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 'Denied' WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 2 WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 'Blocked' WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 2 WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 1 ELSE 0 END
        - name: message
          expr: regexp_extract(properties.msg, r'Action:\s+\w+\.\s+(.*)$', 1)
        - name: ocsf_firewall_rule.name
          expr: regexp_extract(properties.msg, r'Rule:\s+(\w+)', 1)
        - name: ocsf_policy.name
          expr: regexp_extract(properties.msg, r'Policy:\s+(.*?)\.', 1)
        - name: ocsf_unmapped
          expr: to_json(named_struct('RuleCollection', regexp_extract(properties.msg, r'Rule Collection:\s+(.*?)\.', 1), 'RuleCollectionGroup', regexp_extract(properties.msg, r'Rule Collection Group:\s+(.*?)\.', 1)))
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_application_gateway_firewall_log
      filter: "category = 'ApplicationGatewayFirewallLog'"
      fields:
        - name: ocsf_activity_id
          expr: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 2 WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 6 ELSE 0 END
        - name: ocsf_activity_name
          from: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 'Close' WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 'Traffic' ELSE 'Unknown' END
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4001' AS INT)"
        - name: ocsf_class_name
          literal: Network Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST(400100 + (CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 2 WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 6 ELSE 0 END) AS BIGINT)
        - name: ocsf_type_name
          expr: "CONCAT('Network Activity: ', properties.httpMethod)"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: ocsf_metadata.labels
          expr: array(properties.engine)
        - name: ocsf_metadata.uid
          from: properties.instanceId
        - name: action
          expr: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 'Denied' WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 2 WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 'Blocked' WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 'Logged' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Blocked' THEN 2 WHEN from_json(_rescued_data, 'struct<properties:struct<action:string>>').properties.action = 'Matched' THEN 17 ELSE 0 END
        - name: ocsf_src_endpoint.ip
          from: properties.clientIp
        - name: ocsf_dst_endpoint.hostname
          from: properties.hostname
        - name: ocsf_url.url_string
          from: properties.requestUri
        - name: message
          from: properties.message
        - name: ocsf_policy.uid
          from: properties.policyId
        - name: ocsf_policy.name
          from: properties.policyScopeName
        - name: ocsf_policy.desc
          from: properties.policyScope
        - name: ocsf_observables
          expr: "array(
            named_struct('name', 'transactionId', 'type_id', 38, 'type', 'Resource Details Object: transactionId', 'value', properties.transactionId)
          )"
        - name: ocsf_firewall_rule.version
          from: properties.ruleSetVersion
        - name: ocsf_firewall_rule.type
          from: properties.ruleSetType
        - name: ocsf_firewall_rule.uid
          from: properties.ruleId
        - name: ocsf_firewall_rule.condition
          from: properties.ruleGroup
        - name: ocsf_firewall_rule.desc
          from: properties.details.message
        - name: raw_data
          from: properties.details.data
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_az_fw_nat_rule
      filter: "category = 'AZFWNatRule'"
      fields:
        - name: ocsf_activity_id
          expr: CAST('6' AS INT)
        - name: ocsf_activity_name
          literal: Traffic
        - name: ocsf_category_uid
          expr: CAST('4' AS INT)
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4001' AS INT)"
        - name: ocsf_class_name
          literal: Network Activity
        - name: ocsf_severity_id
          expr: CAST('0' AS INT)
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST('400106' AS BIGINT)
        - name: ocsf_type_name
          expr: "CONCAT('Network Activity: Traffic')"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: ocsf_connection_info.protocol_name
          from: properties.Protocol
        - name: ocsf_connection_info.protocol_num
          expr: "CASE WHEN properties.Protocol = 'TCP' THEN 6 WHEN properties.Protocol = 'UDP' THEN 17 WHEN properties.Protocol = 'ICMP' THEN 1 WHEN properties.Protocol = 'ICMPv6' THEN 58 ELSE null END"
        - name: ocsf_src_endpoint.ip
          from: properties.SourceIp
        - name: ocsf_src_endpoint.port
          from: properties.SourcePort
        - name: ocsf_src_endpoint.proxy_endpoint.ip
          from: properties.TranslatedIp
        - name: ocsf_src_endpoint.proxy_endpoint.port
          from: properties.TranslatedPort
        - name: ocsf_dst_endpoint.ip
          from: properties.DestinationIp
        - name: ocsf_dst_endpoint.port
          from: properties.DestinationPort
        - name: ocsf_policy.name
          from: properties.Policy
        - name: ocsf_firewall_rule.name
          from: properties.Rule
        - name: ocsf_unmapped
          expr: to_json(named_struct('RuleCollection', properties.RuleCollection, 'RuleCollectionGroup', properties.RuleCollectionGroup))
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_az_fw_application_rule
      filter: "category = 'AZFWApplicationRule'"
      fields:
        - name: ocsf_activity_id
          expr: CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END
        - name: ocsf_activity_name
          expr: CASE WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 'Unknown' ELSE CONCAT(UPPER(SUBSTRING(properties.httpMethod, 1, 1)), LOWER(SUBSTRING(properties.httpMethod, 2))) END
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: HTTP Activity
        - name: ocsf_class_uid
          expr: "CAST('4002' AS INT)"
        - name: ocsf_class_name
          literal: HTTP Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST(400200 + (CASE WHEN LOWER(properties.httpMethod) = 'connect' THEN 1 WHEN LOWER(properties.httpMethod) = 'delete' THEN 2 WHEN LOWER(properties.httpMethod) = 'get' THEN 3 WHEN LOWER(properties.httpMethod) = 'head' THEN 4 WHEN LOWER(properties.httpMethod) = 'options' THEN 5 WHEN LOWER(properties.httpMethod) = 'post' THEN 6 WHEN LOWER(properties.httpMethod) = 'put' THEN 7 WHEN LOWER(properties.httpMethod) = 'trace' THEN 8 WHEN properties.httpMethod IS NULL OR properties.httpMethod = '' THEN 0 ELSE 99 END) AS BIGINT)
        - name: ocsf_type_name
          expr: "CONCAT('HTTP Activity: ', CASE WHEN properties.httpMethod = '' THEN 'Unknown' ELSE properties.httpMethod END)"
        - name: time
          expr: COALESCE(time, timestamp)
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: action
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Denied' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Blocked' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: ocsf_policy.name
          from: properties.Policy
        - name: ocsf_firewall_rule.desc
          from: properties.ActionReason
        - name: ocsf_firewall_rule.name
          from: properties.Rule
        - name: protocol
          from: properties.Protocol
        - name: ocsf_http_request.url.url_string
          from: properties.TargetUrl
        - name: ocsf_http_request.url.categories
          expr: array(properties.WebCategory)
        - name: ocsf_src_endpoint.ip
          from: properties.SourceIp
        - name: ocsf_src_endpoint.port
          from: properties.SourcePort
        - name: ocsf_dst_endpoint.hostname
          from: properties.Fqdn
        - name: ocsf_dst_endpoint.port
          from: properties.DestinationPort
        - name: ocsf_unmapped
          expr: to_json(named_struct('RuleCollection', properties.RuleCollection, 'RuleCollectionGroup', properties.RuleCollectionGroup, 'IsExplicitProxyRequest', properties.IsExplicitProxyRequest, 'IsTlsInspected', properties.IsTlsInspected))
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_azure_firewall_network_rule
      filter: "category = 'AzureFirewallNetworkRule'"
      fields:
        - name: ocsf_activity_id
          expr: CAST('6' AS INT)
        - name: ocsf_activity_name
          literal: Traffic
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4001' AS INT)"
        - name: ocsf_class_name
          literal: Network Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST(400106 AS BIGINT)
        - name: ocsf_type_name
          literal: "Network Activity: Traffic"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: message
          from: properties.msg
        - name: ocsf_connection_info.protocol_name
          expr: CASE WHEN trim(regexp_extract(properties.msg, r'^(\w+)', 1)) IN ('TCP', 'UDP') THEN regexp_extract(properties.msg, r'^(\w+)', 1) ELSE '' END
        - name: ocsf_connection_info.protocol_num
          expr: CASE WHEN trim(regexp_extract(properties.msg, r'^(\w+)', 1)) = 'TCP' THEN 6 WHEN regexp_extract(properties.msg, r'^(\w+)', 1) = 'UDP' THEN 17 ELSE null END
        - name: ocsf_src_endpoint.hostname
          expr: regexp_extract(properties.msg, r'from\s+([^:]+)', 1)
        - name: ocsf_src_endpoint.port
          expr: CAST((CASE WHEN regexp_extract(properties.msg, r'from\s+[^:]+:(\d+)', 1) = '' THEN null ELSE regexp_extract(properties.msg, r'from\s+[^:]+:(\d+)', 1) END) AS INT)
        - name: ocsf_src_endpoint.proxy_endpoint.hostname
          expr: regexp_extract(properties.msg, r"was DNAT'ed to\\s+([^:]+)", 1)
        - name: ocsf_src_endpoint.proxy_endpoint.port
          expr: CAST((CASE WHEN regexp_extract(properties.msg, r"was DNAT'ed to\\s+[^:]+:(\\d+)", 1) = '' THEN null ELSE regexp_extract(properties.msg, r"was DNAT'ed to\\s+[^:]+:(\\d+)", 1) END) AS INT)
        - name: ocsf_dst_endpoint.hostname
          expr: regexp_extract(properties.msg, r'to\s+([^:]+)', 1)
        - name: ocsf_dst_endpoint.port
          expr: CAST((CASE WHEN regexp_extract(properties.msg, r'to\s+[^:]+:(\d+)', 1) = '' THEN null ELSE regexp_extract(properties.msg, r'to\s+[^:]+:(\d+)', 1) END) AS INT)
        - name: action
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 'Denied' WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 2 WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 'Blocked' WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Deny' THEN 2 WHEN (regexp_extract(properties.msg, r'Action:\s+(\w+)', 1)) = 'Allow' THEN 1 ELSE 0 END
        - name: ocsf_firewall_rule.name
          expr: regexp_extract(properties.msg, r'Rule:\s+(\w+)', 1)
        - name: ocsf_policy.name
          expr: regexp_extract(properties.msg, r'Policy:\s+(.*?)\.', 1)
        - name: ocsf_unmapped
          expr: to_json(named_struct('RuleCollection', regexp_extract(properties.msg, r'Rule Collection:\s+(.*?)\.', 1), 'RuleCollectionGroup', regexp_extract(properties.msg, r'Rule Collection Group:\s+(.*?)\.', 1)))
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_az_fw_network_rule
      filter: "category = 'AZFWNetworkRule'"
      fields:
        - name: ocsf_activity_id
          expr: CAST('6' AS INT)
        - name: ocsf_activity_name
          literal: Traffic
        - name: ocsf_category_uid
          expr: "CAST('4' AS INT)"
        - name: ocsf_category_name
          literal: Network Activity
        - name: ocsf_class_uid
          expr: "CAST('4001' AS INT)"
        - name: ocsf_class_name
          literal: Network Activity
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST(400106 AS BIGINT)
        - name: ocsf_type_name
          literal: "Network Activity: Traffic"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Azure WAF"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: action
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Denied' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Blocked' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: ocsf_policy.name
          from: properties.Policy
        - name: ocsf_firewall_rule.desc
          from: properties.ActionReason
        - name: ocsf_firewall_rule.name
          from: properties.Rule
        - name: ocsf_connection_info.protocol_name
          from: properties.Protocol
        - name: ocsf_connection_info.protocol_num
          expr: "CASE WHEN properties.Protocol = 'TCP' THEN 6 WHEN properties.Protocol = 'UDP' THEN 17 WHEN properties.Protocol = 'ICMP' THEN 1 WHEN properties.Protocol = 'ICMPv6' THEN 58 ELSE null END"
        - name: ocsf_src_endpoint.ip
          from: properties.SourceIp
        - name: ocsf_src_endpoint.port
          from: properties.SourcePort
        - name: ocsf_dst_endpoint.ip
          from: properties.DestinationIp
        - name: ocsf_dst_endpoint.port
          from: properties.DestinationPort
        - name: ocsf_unmapped
          expr: to_json(named_struct('RuleCollection', properties.RuleCollection, 'RuleCollectionGroup', properties.RuleCollectionGroup))
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
    - name: azure_waf_az_fw_threat_intel
      filter: "category = 'AZFWThreatIntel'"
      fields:
        - name: ocsf_activity_id
          expr: CAST('1' AS INT)
        - name: ocsf_activity_name
          literal: Create
        - name: ocsf_category_uid
          expr: "CAST('2' AS INT)"
        - name: ocsf_category_name
          literal: Findings
        - name: ocsf_class_uid
          expr: "CAST('2001' AS INT)"
        - name: ocsf_class_name
          literal: Security Finding
        - name: ocsf_severity_id
          expr: "CAST('0' AS INT)"
        - name: ocsf_severity
          literal: Unknown
        - name: ocsf_type_uid
          expr: CAST(200101 AS BIGINT)
        - name: ocsf_type_name
          literal: "Security Finding: Create"
        - name: time
          expr: "COALESCE(time, timestamp)"
        - name: ocsf_metadata.log_provider
          from: category
        - name: ocsf_metadata.log_name
          from: operationName
        - name: ocsf_metadata.product.name
          literal: "Monitor Logs"
        - name: ocsf_metadata.product.vendor_name
          literal: "Microsoft"
        - name: ocsf_metadata.product.feature.name
          from: category
        - name: ocsf_metadata.tags
          expr: "array(
                  named_struct('name', 'IsTlsInspected', 'value', CAST(properties.IsTlsInspected AS STRING))
                )"
        - name: action
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Denied' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: action_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: disposition
          expr: CASE WHEN properties.Action = 'Deny' THEN 'Blocked' WHEN properties.Action = 'Allow' THEN 'Allowed' ELSE 'Unknown' END
        - name: disposition_id
          expr: CASE WHEN properties.Action = 'Deny' THEN 2 WHEN properties.Action = 'Allow' THEN 1 ELSE 0 END
        - name: ocsf_finding.desc
          from: properties.ThreatDescription
        - name: ocsf_finding.supporting_data
          expr: "CAST(to_json(
              named_struct('SourceIp', properties.SourceIp, 'SourcePort', properties.SourcePort, 'Fqdn', properties.Fqdn, 'DestinationIp', properties.DestinationIp, 'DestinationPort', properties.DestinationPort, 'Protocol', properties.Protocol)) AS VARIANT)"
        - name: ocsf_osint.type
          expr: CASE WHEN properties.Url IS NOT NULL THEN 'URL' ELSE 'Unknown' END
        - name: ocsf_osint.type_id
          expr: CASE WHEN properties.Url IS NOT NULL THEN 5 ELSE 0 END
        - name: ocsf_osint.value
          expr: CASE WHEN (properties.Url IS NOT NULL OR properties.Url != '') THEN properties.Url ELSE null END
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - time
gold:
  - name: http_activity
    input: azure_waf_application_gateway_access_log
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: http_request
        from: ocsf_http_request
      - name: http_response
        from: ocsf_http_response
      - name: connection_info
        from: ocsf_connection_info
      - name: tls
        from: ocsf_tls
      - name: traffic
        from: ocsf_traffic
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: firewall_rule
        from: ocsf_firewall_rule
  - name: http_activity
    input: azure_waf_azure_firewall_application_rule
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: message
        from: message
      - name: metadata
        from: ocsf_metadata
      - name: raw_data
        from: raw_data
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: firewall_rule
        from: ocsf_firewall_rule
      - name: policy
        from: ocsf_policy
      - name: unmapped
        expr: CAST(ocsf_unmapped AS VARIANT)
  - name: network_activity
    input: azure_waf_application_gateway_firewall_log
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: metadata
        from: ocsf_metadata
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: url
        from: ocsf_url
      - name: message
        from: message
      - name: policy
        from: ocsf_policy
      - name: observables
        from: ocsf_observables
      - name: firewall_rule
        from: ocsf_firewall_rule
      - name: raw_data
        from: raw_data
  - name: network_activity
    input: azure_waf_az_fw_nat_rule
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: connection_info
        from: ocsf_connection_info
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: policy
        from: ocsf_policy
      - name: unmapped
        expr: CAST(ocsf_unmapped AS VARIANT)
  - name: http_activity
    input: azure_waf_az_fw_application_rule
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: firewall_rule
        from: ocsf_firewall_rule
      - name: policy
        from: ocsf_policy
      - name: http_request
        from: ocsf_http_request
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: unmapped
        expr: CAST(ocsf_unmapped AS VARIANT)
  - name: network_activity
    input: azure_waf_azure_firewall_network_rule
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: message
        from: message
      - name: connection_info
        from: ocsf_connection_info
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: firewall_rule
        from: ocsf_firewall_rule
      - name: policy
        from: ocsf_policy
      - name: unmapped
        expr: CAST(ocsf_unmapped AS VARIANT)
  - name: network_activity
    input: azure_waf_az_fw_network_rule
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: connection_info
        from: ocsf_connection_info
      - name: src_endpoint
        from: ocsf_src_endpoint
      - name: dst_endpoint
        from: ocsf_dst_endpoint
      - name: firewall_rule
        from: ocsf_firewall_rule
      - name: policy
        from: ocsf_policy
      - name: unmapped
        expr: CAST(ocsf_unmapped AS VARIANT)
  - name: security_finding
    input: azure_waf_az_fw_threat_intel
    fields:
      - name: activity_id
        from: ocsf_activity_id
      - name: activity_name
        from: ocsf_activity_name
      - name: category_uid
        from: ocsf_category_uid
      - name: category_name
        from: ocsf_category_name
      - name: class_uid
        from: ocsf_class_uid
      - name: class_name
        from: ocsf_class_name
      - name: severity_id
        from: ocsf_severity_id
      - name: severity
        from: ocsf_severity
      - name: type_uid
        from: ocsf_type_uid
      - name: type_name
        from: ocsf_type_name
      - name: time
        from: time
      - name: metadata
        from: ocsf_metadata
      - name: action
        from: action
      - name: action_id
        from: action_id
      - name: disposition
        from: disposition
      - name: disposition_id
        from: disposition_id
      - name: finding
        from: ocsf_finding
      - name: osint
        expr: array(ocsf_osint)
