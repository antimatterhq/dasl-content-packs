name: cloudflare_httpreq
author: Antimatter
description: "A preset for consuming logs generated by Cloudflare WAF logs"
title: "Cloudflare - HTTP requests"
iconURL: "https://raw.githubusercontent.com/antimatterhq/dasl-content-packs/refs/heads/main/presets/cloudflare/httpreq/icon.png"

autoloader:
  format: json
  cloudFiles:
    options: {}

bronze:
  loadAsSingleVariant: true
  preTransform:
    - ["data", "CAST(data:EdgeStartTimestamp AS TIMESTAMP) AS time", "CAST('cloudflare' AS STRING) AS source", "CAST('httpreq' AS STRING) AS sourcetype"]
    

silver:
  transform:
    - name: cloudflare_waf_http_requests
      fields:
        - name: time
          from: time
        - name: CacheCacheStatus
          expr: |
            CAST(data:CacheCacheStatus AS STRING)
        - name: CacheResponseBytes
          expr: |
            CAST(data:CacheResponseBytes AS INT)
        - name: ClientASN
          expr: |
            CAST(data:ClientASN AS INT)
        - name: ClientCountry
          expr: |
            CAST(data:ClientCountry AS STRING)
        - name: ClientDeviceType
          expr: |
            CAST(data:ClientDeviceType AS STRING)
        - name: ClientIP
          expr: |
            CAST(data:ClientIP AS STRING)
        - name: ClientIPClass
          expr: |
            CAST(data:ClientIPClass AS STRING)
        - name: ClientMTLSAuthCertFingerprint
          expr: |
            CAST(data:ClientMTLSAuthCertFingerprint AS STRING)
        - name: ClientMTLSAuthStatus
          expr: |
            CAST(data:ClientMTLSAuthStatus AS STRING)
        - name: ClientRegionCode
          expr: |
            CAST(data:ClientRegionCode AS STRING)
        - name: ClientRequestBytes
          expr: |
            CAST(data:ClientRequestBytes AS INT)
        - name: ClientRequestHost
          expr: |
            CAST(data:ClientRequestHost AS STRING)
        - name: ClientRequestMethod
          expr: |
            CAST(data:ClientRequestMethod AS STRING)
        - name: ClientRequestPath
          expr: |
            CAST(data:ClientRequestPath AS STRING)
        - name: ClientRequestProtocol
          expr: |
            CAST(data:ClientRequestProtocol AS STRING)
        - name: ClientRequestReferer
          expr: |
            CAST(data:ClientRequestReferer AS STRING)
        - name: ClientRequestScheme
          expr: |
            CAST(data:ClientRequestScheme AS STRING)
        - name: ClientRequestSource
          expr: |
            CAST(data:ClientRequestSource AS STRING)
        - name: ClientRequestURI
          expr: |
            CAST(data:ClientRequestURI AS STRING)
        - name: ClientRequestUserAgent
          expr: |
            CAST(data:ClientRequestUserAgent AS STRING)
        - name: ClientSSLProtocol
          expr: |
            CAST(data:ClientSSLProtocol AS STRING)
        - name: EdgeColoCode
          expr: |
            CAST(data:EdgeColoCode AS STRING)
        - name: EdgeEndTimestamp
          expr: |
            CAST(data:EdgeEndTimestamp AS STRING)
        - name: EdgePathingOp
          expr: |
            CAST(data:EdgePathingOp AS STRING)
        - name: EdgePathingSrc
          expr: |
            CAST(data:EdgePathingSrc AS STRING)
        - name: EdgePathingStatus
          expr: |
            CAST(data:EdgePathingStatus AS STRING)
        - name: EdgeResponseBytes
          expr: |
            CAST(data:EdgeResponseBytes AS INT)
        - name: EdgeResponseContentType
          expr: |
            CAST(data:EdgeResponseContentType AS STRING)
        - name: EdgeResponseStatus
          expr: |
            CAST(data:EdgeResponseStatus AS INT)
        - name: EdgeServerIP
          expr: |
            CAST(data:EdgeServerIP AS STRING)
        - name: EdgeStartTimestamp
          expr: |
            CAST(data:EdgeStartTimestamp AS STRING)
        - name: OriginIP
          expr: |
            CAST(data:OriginIP AS STRING)
        - name: OriginResponseDurationMs
          expr: |
            CAST(data:OriginResponseDurationMs AS INT)
        - name: OriginResponseHTTPLastModified
          expr: |
            CAST(data:OriginResponseHTTPLastModified AS STRING)
        - name: OriginResponseStatus
          expr: |
            CAST(data:OriginResponseStatus AS INT)
        - name: OriginSSLProtocol
          expr: |
            CAST(data:OriginSSLProtocol AS STRING)
        - name: ParentRayID
          expr: |
            CAST(data:ParentRayID AS STRING)
        - name: RayID
          expr: |
            CAST(data:RayID AS STRING)
        - name: SecurityAction
          expr: |
            CAST(data:SecurityAction AS STRING)
        - name: SecurityActions
          expr: |
            CAST(data:SecurityActions AS ARRAY<STRING>)
        - name: SecurityRuleDescription
          expr: |
            CAST(data:SecurityRuleDescription AS STRING)
        - name: SecurityRuleID
          expr: |
            CAST(data:SecurityRuleID AS STRING)
        - name: SecurityRuleIDs
          expr: |
            CAST(data:SecurityRuleIDs AS ARRAY<STRING>)
        - name: SecuritySources
          expr: |
            CAST(data:SecuritySources AS ARRAY<STRING>)
        - name: WAFAttackScore
          expr: |
            CAST(data:WAFAttackScore AS INT)
        - name: WAFRCEAttackScore
          expr: |
            CAST(data:WAFRCEAttackScore AS INT)
        - name: WAFSQLiAttackScore
          expr: |
            CAST(data:WAFSQLiAttackScore AS INT)
        - name: WAFXSSAttackScore
          expr: |
            CAST(data:WAFXSSAttackScore AS INT)
        - name: WorkerStatus
          expr: |
            CAST(data:WorkerStatus AS STRING)
        - name: WorkerSubrequest
          expr: |
            CAST(data:WorkerSubrequest AS BOOLEAN)
        - name: ZoneName
          expr: |
            CAST(data:ZoneName AS STRING)


gold:
  - name: http_activity
    input: cloudflare_waf_http_requests
    fields:
      # ------------------ timestamps ------------------
      - name: time
        from: time

      - name: timezone_offset
        expr: CAST(0 AS INT)

      # ------------------ core/base fields ------------------
      - name: action
        expr: |
          CASE
            WHEN array_contains(ARRAY('allow'), SecurityAction) THEN 'Allowed'
            WHEN array_contains(ARRAY('connectionClose','forceConnectionClose','block'), SecurityAction) THEN 'Denied'
            WHEN array_contains(ARRAY('skip','bypass','log'), SecurityAction) THEN 'Observed'
            WHEN array_contains(ARRAY('rewrite','challenge','jschallenge','managedChallenge','managedChallengeNonInteractiveSolved','managedChallengeInteractiveSolved','challengeSolved','jschallengeSolved','challengeBypassed','managedChallengeBypassed','jschallengeBypassed'), SecurityAction) THEN 'Modified'
            WHEN array_contains(ARRAY('unknown'), SecurityAction) THEN 'Unknown'
            ELSE 'Other'
          END

      - name: action_id
        expr: |
          CASE
            WHEN array_contains(ARRAY('allow'), SecurityAction) THEN 1
            WHEN array_contains(ARRAY('connectionClose','forceConnectionClose','block'), SecurityAction) THEN 2
            WHEN array_contains(ARRAY('skip','bypass','log'), SecurityAction) THEN 3
            WHEN array_contains(ARRAY('rewrite','challenge','jschallenge','managedChallenge','managedChallengeNonInteractiveSolved','managedChallengeInteractiveSolved','challengeSolved','jschallengeSolved','challengeBypassed','managedChallengeBypassed','jschallengeBypassed'), SecurityAction) THEN 4
            WHEN array_contains(ARRAY('unknown'), SecurityAction) THEN 0
            ELSE 99
          END

      - name: activity_id
        expr: |
          CASE
            WHEN LOWER(ClientRequestMethod) = 'connect' THEN 1
            WHEN LOWER(ClientRequestMethod) = 'delete' THEN 2
            WHEN LOWER(ClientRequestMethod) = 'get' THEN 3
            WHEN LOWER(ClientRequestMethod) = 'head' THEN 4
            WHEN LOWER(ClientRequestMethod) = 'options' THEN 5
            WHEN LOWER(ClientRequestMethod) = 'post' THEN 6
            WHEN LOWER(ClientRequestMethod) = 'put' THEN 7
            WHEN LOWER(ClientRequestMethod) = 'trace' THEN 8
            WHEN ClientRequestMethod IS NULL OR ClientRequestMethod = '' THEN 0
            ELSE 99
          END

      - name: activity
        expr: |
          CASE
            WHEN LOWER(ClientRequestMethod) = 'connect' THEN 'Connect'
            WHEN LOWER(ClientRequestMethod) = 'delete' THEN 'Delete'
            WHEN LOWER(ClientRequestMethod) = 'get' THEN 'Get'
            WHEN LOWER(ClientRequestMethod) = 'head' THEN 'Head'
            WHEN LOWER(ClientRequestMethod) = 'options' THEN 'Options'
            WHEN LOWER(ClientRequestMethod) = 'post' THEN 'Post'
            WHEN LOWER(ClientRequestMethod) = 'put' THEN 'Put'
            WHEN LOWER(ClientRequestMethod) = 'trace' THEN 'Trace'
            WHEN ClientRequestMethod IS NULL OR ClientRequestMethod = '' THEN 'Unknown'
            ELSE 'Unknown'
          END

      - name: activity_name
        expr: |
          CASE
            WHEN ClientRequestMethod IS NULL OR ClientRequestMethod = '' THEN ClientRequestMethod
            ELSE CONCAT(UPPER(SUBSTRING(ClientRequestMethod, 1, 1)), LOWER(SUBSTRING(ClientRequestMethod, 2)))
          END

      - name: app_name
        from: ClientRequestUserAgent

      - name: category_name
        literal: "Network Activity"

      - name: category_uid
        expr: CAST(4 AS INT)

      - name: class_name
        literal: "HTTP Activity"

      - name: class_uid
        expr: CAST(4002 AS INT)

      - name: severity
        literal: "Informational"

      - name: severity_id
        expr: CAST(1 AS INT)

      - name: status
        expr: |
          CASE
            WHEN CAST(EdgeResponseStatus AS INT) BETWEEN 200 AND 299 THEN 'Success'
            WHEN CAST(EdgeResponseStatus AS INT) >= 300 THEN 'Failure'
            ELSE 'Unknown'
          END

      - name: status_code
        expr: CAST(EdgeResponseStatus AS STRING)

      - name: status_detail
        expr: CAST(NULL AS STRING)

      - name: status_id
        expr: |
          CASE
            WHEN CAST(EdgeResponseStatus AS INT) BETWEEN 200 AND 299 THEN 1
            WHEN CAST(EdgeResponseStatus AS INT) >= 300 THEN 2
            ELSE 0
          END

      - name: type_uid
        expr: |
          CAST(
            400200 +
            CASE
              WHEN LOWER(ClientRequestMethod) = 'connect' THEN 1
              WHEN LOWER(ClientRequestMethod) = 'delete' THEN 2
              WHEN LOWER(ClientRequestMethod) = 'get' THEN 3
              WHEN LOWER(ClientRequestMethod) = 'head' THEN 4
              WHEN LOWER(ClientRequestMethod) = 'options' THEN 5
              WHEN LOWER(ClientRequestMethod) = 'post' THEN 6
              WHEN LOWER(ClientRequestMethod) = 'put' THEN 7
              WHEN LOWER(ClientRequestMethod) = 'trace' THEN 8
              WHEN ClientRequestMethod IS NULL OR ClientRequestMethod = '' THEN 0
              ELSE 99
            END
          AS BIGINT)

      - name: type_name
        expr: |
          CASE
            WHEN ClientRequestMethod IS NOT NULL
            THEN CONCAT('HTTP Activity: ', ClientRequestMethod)
            ELSE NULL
          END

      # ------------------ disposition ------------------
      - name: disposition
        expr: CAST(NULL AS STRING)

      - name: disposition_id
        expr: CAST(NULL AS INT)

      # ------------------ connection_info ------------------
      - name: connection_info.direction
        literal: "Inbound"

      - name: connection_info.direction_id
        expr: CAST(1 AS INT)

      - name: connection_info.flag_history
        expr: CAST(NULL AS STRING)

      - name: connection_info.protocol_name
        from: ClientRequestProtocol

      - name: connection_info.protocol_num
        expr: CAST(6 AS INT)

      - name: connection_info.protocol_ver
        expr: CAST(NULL AS STRING)

      - name: connection_info.protocol_ver_id
        expr: CAST(NULL AS INT)

      - name: connection_info.uid
        expr: CAST(RayID AS STRING)

      # ------------------ dst_endpoint ------------------
      - name: dst_endpoint.domain
        from: ClientRequestHost
      - name: dst_endpoint.hostname
        from: ClientRequestHost
      - name: dst_endpoint.instance_uid
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.interface_name
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.interface_uid
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.ip
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.name
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.port
        expr: |
          CASE
            WHEN INSTR(ClientRequestHost, ':') > 0 THEN CAST(SPLIT(ClientRequestHost, ':')[1] AS INT)
            WHEN LOWER(ClientRequestScheme) = 'https' THEN 443
            WHEN LOWER(ClientRequestScheme) = 'http'  THEN 80
            ELSE 0
          END
      - name: dst_endpoint.svc_name
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.type
        literal: "Server"
      - name: dst_endpoint.type_id
        expr: CAST(1 AS INT)
      - name: dst_endpoint.uid
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.location.city
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.location.continent
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.location.country
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.location.lat
        expr: CAST(NULL AS FLOAT)
      - name: dst_endpoint.location.long
        expr: CAST(NULL AS FLOAT)
      - name: dst_endpoint.location.postal_code
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.mac
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.vpc_uid
        expr: CAST(NULL AS STRING)
      - name: dst_endpoint.zone
        expr: CAST(NULL AS STRING)

      # ------------------ http_request ------------------
      - name: http_request.args
        expr: CAST(NULL AS STRING)
      - name: http_request.body_length
        expr: CAST(NULL AS INT)
      - name: http_request.http_headers
        expr: |
          CAST(array() AS ARRAY<STRUCT<name: STRING, value: STRING>>)
      - name: http_request.http_method
        from: ClientRequestMethod
      - name: http_request.length
        expr: CAST(ClientRequestBytes AS INT)
      - name: http_request.referrer
        expr: COALESCE(ClientRequestReferer, '')
      - name: http_request.url
        expr: CONCAT(ClientRequestScheme, '://', ClientRequestHost, ClientRequestPath)
      - name: http_request.user_agent
        from: ClientRequestUserAgent
      - name: http_request.version
        expr: SPLIT(ClientRequestProtocol, '/')[SIZE(SPLIT(ClientRequestProtocol, '/')) - 1]

      # ------------------ http_response ------------------
      - name: http_response.body_length
        expr: CAST(EdgeResponseBytes AS INT)
      - name: http_response.code
        expr: CAST(EdgeResponseStatus AS INT)
      - name: http_response.content_type
        from: EdgeResponseContentType
      - name: http_response.http_headers
        expr: |
          CAST(array() AS ARRAY<STRUCT<name: STRING, value: STRING>>)
      - name: http_response.latency
        expr: CAST(NULL AS INT)
      - name: http_response.length
        expr: CAST(NULL AS INT)
      - name: http_response.message
        expr: CAST(NULL AS STRING)
      - name: http_response.status
        expr: CAST(NULL AS STRING)

      # ------------------ src_endpoint ------------------
      - name: src_endpoint.domain
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.hostname
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.instance_uid
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.interface_name
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.interface_uid
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.ip
        from: ClientIP
      - name: src_endpoint.name
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.port
        expr: CAST(NULL AS INT)
      - name: src_endpoint.svc_name
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.type
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.type_id
        expr: CAST(NULL AS INT)
      - name: src_endpoint.uid
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.location.city
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.location.continent
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.location.country
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.location.lat
        expr: CAST(NULL AS FLOAT)
      - name: src_endpoint.location.long
        expr: CAST(NULL AS FLOAT)
      - name: src_endpoint.location.postal_code
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.mac
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.vpc_uid
        expr: CAST(NULL AS STRING)
      - name: src_endpoint.zone
        expr: CAST(NULL AS STRING)

      # ------------------ metadata ------------------
      - name: metadata.correlation_uid
        expr: CAST(NULL AS STRING)
      - name: metadata.event_code
        expr: CAST(NULL AS STRING)
      - name: metadata.log_level
        literal: "Informational"
      - name: metadata.log_name
        literal: "httpreq"
      - name: metadata.log_provider
        literal: "cloudflare"
      - name: metadata.log_version
        literal: "unknown"
      - name: metadata.logged_time
        from: time
      - name: metadata.modified_time
        expr: CAST(NULL AS TIMESTAMP)
      - name: metadata.original_time
        from: time
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.product.name
        literal: "web application firewall"
      - name: metadata.product.vendor_name
        literal: "cloudflare"
      - name: metadata.product.version
        literal: "1.4.0"
      - name: metadata.tags
        expr: CAST(NULL AS VARIANT)
      - name: metadata.tenant_uid
        expr: CAST(NULL AS STRING)
      - name: metadata.uid
        expr: CAST(RayID AS STRING)
      - name: metadata.version
        literal: "1.4.0"

      # ------------------ arrays/objects required by schema ------------------
      - name: enrichments
        expr: |
          CAST(array() AS ARRAY<STRUCT<data: VARIANT, desc: STRING, name: STRING, value: STRING>>)

      - name: file
        expr: |
          named_struct(
            'name', CAST(NULL AS STRING),
            'path', CAST(NULL AS STRING)
          )

      - name: http_cookies
        expr: |
          CAST(array() AS ARRAY<STRUCT<
            domain: STRING,
            expiration_time: TIMESTAMP,
            http_only: BOOLEAN,
            is_http_only: BOOLEAN,
            is_secure: BOOLEAN,
            name: STRING,
            path: STRING,
            samesite: STRING,
            secure: BOOLEAN,
            value: STRING
          >>)

      - name: observables
        expr: |
          CAST(array() AS ARRAY<STRUCT<name: STRING, type: STRING, value: STRING>>)

      - name: policy
        expr: |
          named_struct(
            'is_applied', CAST(NULL AS BOOLEAN),
            'name', CAST(NULL AS STRING),
            'uid', CAST(NULL AS STRING),
            'version', CAST(NULL AS STRING)
          )

      # ------------------ firewall_rule ------------------
      - name: firewall_rule.name
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.uid
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.category
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.desc
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.type
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.version
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.condition
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.duration
        expr: CAST(NULL AS LONG)
      - name: firewall_rule.match_details
        expr: |
          CAST(array() AS ARRAY<STRING>)
      - name: firewall_rule.match_location
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.rate_limit
        expr: CAST(NULL AS INT)
      - name: firewall_rule.sensitivity
        expr: CAST(NULL AS STRING)

      # ------------------ traffic ------------------
      - name: traffic.bytes_in
        expr: CAST(ClientRequestBytes AS LONG)
      - name: traffic.bytes_out
        expr: CAST(EdgeResponseBytes AS LONG)
      - name: traffic.bytes
        expr: CAST(COALESCE(EdgeResponseBytes, 0) + COALESCE(ClientRequestBytes, 0) AS LONG)
      - name: traffic.bytes_missed
        expr: CAST(NULL AS LONG)
      - name: traffic.chunks
        expr: CAST(NULL AS LONG)
      - name: traffic.chunks_in
        expr: CAST(NULL AS LONG)
      - name: traffic.chunks_out
        expr: CAST(NULL AS LONG)
      - name: traffic.packets
        expr: CAST(NULL AS LONG)
      - name: traffic.packets_in
        expr: CAST(NULL AS LONG)
      - name: traffic.packets_out
        expr: CAST(NULL AS LONG)

      # ------------------ message/raw/unmapped ------------------
      - name: message
        from: SecurityAction

      - name: raw_data
        expr: |
          CAST(to_json(named_struct(
            'EdgeStartTimestamp', EdgeStartTimestamp,
            'ClientRequestMethod', ClientRequestMethod,
            'ClientRequestProtocol', ClientRequestProtocol,
            'ClientRequestHost', ClientRequestHost,
            'ClientRequestPath', ClientRequestPath,
            'ClientRequestBytes', ClientRequestBytes,
            'EdgeResponseBytes', EdgeResponseBytes,
            'EdgeResponseStatus', EdgeResponseStatus,
            'EdgeResponseContentType', EdgeResponseContentType,
            'ClientRequestUserAgent', ClientRequestUserAgent,
            'ClientRequestReferer', ClientRequestReferer,
            'ClientRequestScheme', ClientRequestScheme,
            'ClientIP', ClientIP,
            'RayID', RayID,
            'SecurityAction', SecurityAction
          )) AS VARIANT)

      - name: unmapped
        expr: CAST(NULL AS VARIANT)